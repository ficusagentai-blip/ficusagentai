<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FicusAgentAI ‚Äî Workspace</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fraunces:ital,wght@0,400;0,600;0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f7f3;--bg2:#edf0e9;--surface:#ffffff;--surface2:#f8faf6;
  --border:rgba(74,120,55,0.13);--border2:rgba(74,120,55,0.28);
  --green:#2d6a2f;--green2:#3d8b40;--green3:#52a855;--green4:#7dc47f;--green5:#c2e0c3;--green6:#e8f5e9;
  --gold:#b8860b;--gold2:#d4a017;--gold3:#f0c040;--gold-bg:#fdf8ec;
  --text:#1a2e1a;--text2:#3d5e3d;--text3:#6b8f6b;--text4:#9db89d;
  --danger:#c0392b;--warn:#d68910;--info:#1a6fa8;--success:#1e8449;
  --shadow-sm:0 1px 4px rgba(30,60,30,0.07),0 0 0 1px rgba(74,120,55,0.06);
  --shadow:0 4px 16px rgba(30,60,30,0.1),0 1px 4px rgba(30,60,30,0.06);
  --shadow-lg:0 12px 40px rgba(30,60,30,0.14),0 4px 12px rgba(30,60,30,0.08);
  --radius:14px;--radius-sm:9px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;right:0;width:600px;height:600px;background:radial-gradient(ellipse at top right,rgba(82,168,85,0.07) 0%,transparent 65%);pointer-events:none;z-index:0;}

/* CONFIG */
#config-screen{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f0f5ee,#e8f0e5);}
.config-card{background:white;border-radius:20px;padding:36px;width:480px;max-width:96vw;box-shadow:var(--shadow-lg);border:1px solid var(--border2);}
.config-logo{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.config-logo-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.config-logo-icon img{width:44px;height:44px;object-fit:cover;border-radius:12px;}
.config-logo-text{font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--green);}
.config-title{font-size:16px;font-weight:800;color:var(--text);margin-bottom:6px;}
.config-sub{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:24px;line-height:1.6;}
.config-field{margin-bottom:14px;}
.config-label{display:block;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:5px;letter-spacing:0.5px;text-transform:uppercase;}
.config-input{width:100%;padding:11px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:all 0.2s;}
.config-input:focus{border-color:var(--green3);background:white;box-shadow:0 0 0 3px rgba(82,168,85,0.1);}
.config-input::placeholder{color:var(--text4);}
.config-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--green),var(--green2));border:none;border-radius:var(--radius-sm);color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px;box-shadow:0 4px 16px rgba(45,106,47,0.3);transition:all 0.2s;}
.config-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(45,106,47,0.4);}
.config-note{font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:14px;padding:10px 12px;background:var(--gold-bg);border:1px solid rgba(184,134,11,0.2);border-radius:8px;line-height:1.7;}
.config-err{font-size:12px;color:var(--danger);margin-top:6px;min-height:16px;font-family:'DM Mono',monospace;}

/* LOADING */
#loading-screen{position:fixed;inset:0;z-index:400;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#f0f5ee,#e8f0e5);}
.loader{width:48px;height:48px;border:4px solid var(--green5);border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'DM Mono',monospace;font-size:13px;color:var(--text3);}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:200;display:none;background:linear-gradient(135deg,#f0f5ee 0%,#e8f0e5 50%,#f5f9f3 100%);}
.login-wrap{display:flex;height:100%;}
.login-left{flex:1;display:flex;align-items:center;justify-content:center;padding:40px;position:relative;overflow:hidden;}
.login-left::before{content:'';position:absolute;top:-100px;left:-100px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(45,106,47,0.08) 0%,transparent 65%);}
.login-brand{position:relative;z-index:2;text-align:center;}
.brand-logo-wrap{width:90px;height:90px;border-radius:24px;overflow:hidden;margin:0 auto 24px;box-shadow:0 12px 40px rgba(45,106,47,0.35);}
.brand-logo-wrap img{width:90px;height:90px;object-fit:cover;}
.login-brand h1{font-family:'Fraunces',serif;font-size:38px;font-weight:700;color:var(--green);line-height:1.1;margin-bottom:10px;}
.login-brand p{font-size:13px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.login-features{margin-top:48px;display:flex;flex-direction:column;gap:14px;}
.feat-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,0.6);border:1px solid rgba(45,106,47,0.12);border-radius:10px;font-size:13px;color:var(--text2);}
.login-right{width:440px;background:white;display:flex;align-items:center;justify-content:center;padding:48px 40px;box-shadow:-20px 0 60px rgba(30,60,30,0.08);}
.login-form-wrap{width:100%;animation:slideIn 0.5s ease;}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.login-form-title{font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:var(--text);margin-bottom:6px;}
.login-form-sub{font-size:13px;color:var(--text3);margin-bottom:28px;}
.role-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:24px;padding:5px;background:var(--bg2);border-radius:12px;}
.role-tab{padding:12px;border-radius:9px;cursor:pointer;transition:all 0.2s;text-align:center;border:1px solid transparent;}
.role-tab.active{background:white;box-shadow:var(--shadow-sm);border-color:var(--border);}
.role-tab-icon{font-size:20px;margin-bottom:4px;}
.role-tab-name{font-size:13px;font-weight:700;color:var(--text2);}
.role-tab-sub{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;letter-spacing:1px;}
.role-tab.active .role-tab-name{color:var(--green);}
.field{margin-bottom:16px;}
.field-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.field-input,.field-select{width:100%;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;outline:none;transition:all 0.2s;}
.field-input:focus,.field-select:focus{border-color:var(--green3);background:white;box-shadow:0 0 0 4px rgba(82,168,85,0.1);}
.field-input::placeholder{color:var(--text4);}
.field-error{font-size:12px;color:var(--danger);margin-top:5px;min-height:16px;}
.login-submit{width:100%;padding:13px;background:linear-gradient(135deg,var(--green),var(--green2));border:none;border-radius:var(--radius-sm);color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:8px;box-shadow:0 4px 16px rgba(45,106,47,0.3);}
.login-submit:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(45,106,47,0.4);}
.login-hint{text-align:center;margin-top:16px;font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;}

/* APP */
#app{display:none;position:relative;z-index:10;min-height:100vh;}
.topbar{position:sticky;top:0;z-index:100;height:62px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:rgba(255,255,255,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);box-shadow:0 1px 8px rgba(30,60,30,0.06);}
.topbar-logo{display:flex;align-items:center;gap:10px;}
.tb-icon{width:34px;height:34px;border-radius:9px;overflow:hidden;}
.tb-icon img{width:34px;height:34px;object-fit:cover;}
.tb-brand{font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--green);}
.tb-badge{padding:3px 10px;border-radius:20px;font-size:10px;font-family:'DM Mono',monospace;font-weight:500;letter-spacing:1px;}
.tb-badge-founder{background:var(--gold-bg);color:var(--gold);border:1px solid rgba(184,134,11,0.25);}
.tb-badge-emp{background:var(--green6);color:var(--green2);border:1px solid rgba(61,139,64,0.25);}
.topbar-center{flex:1;max-width:360px;margin:0 24px;}
.search-bar{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg2);border:1.5px solid var(--border);border-radius:10px;transition:all 0.2s;}
.search-bar:focus-within{background:white;border-color:var(--green3);box-shadow:0 0 0 4px rgba(82,168,85,0.08);}
.search-input{flex:1;background:none;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);}
.search-input::placeholder{color:var(--text4);}
.topbar-right{display:flex;align-items:center;gap:10px;}
.watch{display:flex;flex-direction:column;align-items:flex-end;padding:6px 12px;background:var(--green6);border:1px solid var(--border);border-radius:9px;}
.watch-time{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--green);line-height:1;}
.watch-date{font-family:'DM Mono',monospace;font-size:9px;color:var(--text4);letter-spacing:1px;margin-top:2px;}
.notif-btn{position:relative;width:38px;height:38px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all 0.2s;}
.notif-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:var(--danger);border:2px solid white;display:none;}
.notif-btn.has-notif .notif-dot{display:block;}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 6px;background:var(--surface);border:1.5px solid var(--border);border-radius:30px;cursor:pointer;box-shadow:var(--shadow-sm);}
.u-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;overflow:hidden;}
.u-av-founder{background:linear-gradient(135deg,#f0c040,#d4a017);color:white;}
.u-av-emp{background:linear-gradient(135deg,var(--green3),var(--green));color:white;}
.u-name{font-size:13px;font-weight:700;color:var(--text);}
.u-role{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}
.logout-btn{padding:7px 14px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.logout-btn:hover{border-color:var(--danger);color:var(--danger);}

/* ONLINE TIMER BADGE */
.online-badge{display:flex;align-items:center;gap:6px;padding:5px 12px;background:var(--green6);border:1.5px solid rgba(82,168,85,0.4);border-radius:20px;font-size:11px;font-family:'DM Mono',monospace;color:var(--green);font-weight:700;cursor:pointer;}
.online-badge .pulse{width:7px;height:7px;border-radius:50%;background:var(--success);animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.2)}}

.app-layout{display:grid;grid-template-columns:230px 1fr;min-height:calc(100vh - 62px);}
.sidebar{background:white;border-right:1px solid var(--border);padding:16px 10px;position:sticky;top:62px;height:calc(100vh - 62px);overflow-y:auto;}
.nav-label{font-size:10px;font-weight:700;color:var(--text4);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;padding:0 10px;margin:14px 0 6px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:9px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text3);transition:all 0.15s;border:1.5px solid transparent;margin-bottom:1px;}
.nav-item:hover{background:var(--green6);color:var(--green);}
.nav-item.active{background:var(--green6);border-color:rgba(82,168,85,0.3);color:var(--green);}
.nav-item.active .nav-icon-wrap{background:linear-gradient(135deg,var(--green),var(--green2));color:white;}
.nav-icon-wrap{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;background:var(--bg2);color:var(--text3);transition:all 0.15s;flex-shrink:0;}
.nav-count{margin-left:auto;background:var(--green6);color:var(--green2);border:1px solid rgba(61,139,64,0.2);border-radius:12px;padding:1px 8px;font-size:10px;font-family:'DM Mono',monospace;}
.nav-count.red{background:#fdf0ef;color:var(--danger);border-color:rgba(192,57,43,0.2);}
.sidebar-divider{height:1px;background:var(--border);margin:10px 0;}
.sm-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:9px;margin-bottom:2px;cursor:pointer;transition:all 0.15s;}
.sm-card:hover{background:var(--green6);}
.sm-av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;}
.sm-info{flex:1;min-width:0;}
.sm-name{font-size:12px;font-weight:600;color:var(--text2);}
.sm-role{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;}
.sm-dot{width:7px;height:7px;border-radius:50%;}
.dot-on{background:var(--success);box-shadow:0 0 4px var(--green3);}
.dot-off{background:var(--text4);}
.main{padding:28px 30px;overflow-y:auto;}
.page{display:none;animation:pageIn 0.3s ease;}
.page.active{display:block;}
@keyframes pageIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;}
.ph-title{font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:var(--text);}
.ph-sub{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.ph-actions{display:flex;gap:8px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stats-row-5{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px;}
.stat-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);transition:all 0.2s;position:relative;overflow:hidden;}
.stat-card:hover{box-shadow:var(--shadow);transform:translateY(-1px);}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius) var(--radius) 0 0;}
.sc-green::after{background:linear-gradient(90deg,var(--green),var(--green3));}
.sc-gold::after{background:linear-gradient(90deg,var(--gold),var(--gold3));}
.sc-blue::after{background:linear-gradient(90deg,#1a6fa8,#4a9fd4);}
.sc-purple::after{background:linear-gradient(90deg,#7e5bef,#a78bfa);}
.stat-icon-wrap{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:12px;}
.sic-green{background:var(--green6);}
.sic-gold{background:var(--gold-bg);}
.sic-blue{background:#e8f4fd;}
.sic-purple{background:#f3f0ff;}
.stat-label{font-size:11px;font-weight:600;color:var(--text4);letter-spacing:1px;text-transform:uppercase;}
.stat-value{font-family:'Fraunces',serif;font-size:34px;font-weight:700;line-height:1;margin:4px 0;}
.sc-green .stat-value{color:var(--green);}
.sc-gold .stat-value{color:var(--gold);}
.sc-blue .stat-value{color:var(--info);}
.sc-purple .stat-value{color:#7e5bef;}
.stat-sub{font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;}
.sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.sec-title{font-size:14px;font-weight:800;color:var(--text);display:flex;align-items:center;gap:8px;}
.sec-title::before{content:'';width:4px;height:16px;background:linear-gradient(to bottom,var(--green),var(--green3));border-radius:2px;}
.btn{padding:9px 18px;border-radius:var(--radius-sm);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.18s;display:inline-flex;align-items:center;gap:6px;border:1.5px solid transparent;}
.btn-primary{background:linear-gradient(135deg,var(--green),var(--green2));color:white;border-color:var(--green2);box-shadow:0 2px 8px rgba(45,106,47,0.25);}
.btn-primary:hover{box-shadow:0 4px 16px rgba(45,106,47,0.35);transform:translateY(-1px);}
.btn-outline{background:white;color:var(--green);border-color:var(--border2);}
.btn-outline:hover{border-color:var(--green3);background:var(--green6);}
.btn-ghost{background:transparent;color:var(--text3);border-color:var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text2);}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:white;border-color:var(--gold2);}
.btn-danger{background:rgba(192,57,43,0.06);color:var(--danger);border-color:rgba(192,57,43,0.2);}
.btn-sm{padding:5px 12px;font-size:11px;}
.tbl-wrap{background:white;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:22px;}
.tbl{width:100%;border-collapse:collapse;}
.tbl th{padding:11px 16px;text-align:left;font-size:10px;font-weight:700;color:var(--text4);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;border-bottom:1px solid var(--border);background:var(--surface2);}
.tbl td{padding:13px 16px;font-size:13px;color:var(--text2);border-bottom:1px solid rgba(74,120,55,0.05);vertical-align:middle;}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:var(--green6);}
.td-name{color:var(--text)!important;font-weight:700;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;white-space:nowrap;}
.b-done{background:var(--green6);color:var(--success);border:1px solid rgba(30,132,73,0.2);}
.b-prog{background:#e8f4fd;color:var(--info);border:1px solid rgba(26,111,168,0.2);}
.b-pend{background:#fef9e7;color:var(--warn);border:1px solid rgba(214,137,16,0.2);}
.b-block{background:#fdf0ef;color:var(--danger);border:1px solid rgba(192,57,43,0.2);}
.b-dep{background:var(--green6);color:var(--success);border:1px solid rgba(30,132,73,0.25);}
.b-ndep{background:#fdf0ef;color:var(--danger);border:1px solid rgba(192,57,43,0.2);}
.b-na{background:var(--bg2);color:var(--text4);border:1px solid var(--border);}
.b-client{background:var(--gold-bg);color:var(--gold);border:1px solid rgba(184,134,11,0.2);}
.b-internal{background:var(--green6);color:var(--green);border:1px solid var(--border2);}
.b-carry{background:#fff3e0;color:#e65100;border:1px solid rgba(230,81,0,0.3);}
.prio{display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;}
.pd{width:7px;height:7px;border-radius:50%;}
.ph-dot{background:var(--danger);}.pm-dot{background:var(--warn);}.pl-dot{background:var(--success);}
.a-chip{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:16px;background:var(--surface2);border:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text2);}
.r-actions{display:flex;gap:5px;}
.r-btn{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--border);background:white;color:var(--text3);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;}
.r-btn:hover{border-color:var(--green3);color:var(--green);background:var(--green6);}
.r-btn.del:hover{border-color:rgba(192,57,43,0.3);color:var(--danger);background:rgba(192,57,43,0.04);}
.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:24px;}
.team-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);transition:all 0.2s;}
.team-card:hover{box-shadow:var(--shadow);border-color:var(--border2);}
.tc-top{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.tc-av{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;}
.tc-name{font-size:15px;font-weight:800;color:var(--text);}
.tc-role{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.tc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.tc-s{text-align:center;padding:10px 6px;background:var(--surface2);border-radius:9px;border:1px solid var(--border);}
.tc-sv{font-family:'Fraunces',serif;font-size:22px;font-weight:700;}
.tc-sl{font-size:9px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;letter-spacing:1px;text-transform:uppercase;}
.prog-bar{height:4px;background:var(--bg2);border-radius:4px;overflow:hidden;margin-bottom:6px;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--green3));border-radius:4px;transition:width 0.5s ease;}
.prog-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;}
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}
.proj-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);transition:all 0.2s;}
.proj-card:hover{box-shadow:var(--shadow);border-color:var(--border2);transform:translateY(-2px);}
.pc-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.pc-name{font-size:15px;font-weight:800;color:var(--text);}
.pc-desc{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;line-height:1.6;margin-bottom:14px;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(20,40,20,0.45);backdrop-filter:blur(6px);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:white;border:1px solid var(--border2);border-radius:18px;padding:28px;width:500px;max-width:96vw;box-shadow:var(--shadow-lg);transform:translateY(-20px) scale(0.97);transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);max-height:88vh;overflow-y:auto;}
.modal-overlay.open .modal{transform:translateY(0) scale(1);}
.modal-wide{width:640px;}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.modal-title{font-family:'Fraunces',serif;font-size:20px;font-weight:700;color:var(--text);}
.close-btn{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text3);transition:all 0.15s;border:1px solid transparent;}
.close-btn:hover{background:rgba(192,57,43,0.06);border-color:rgba(192,57,43,0.2);color:var(--danger);}
.f-group{margin-bottom:15px;}
.f-label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:5px;}
.f-input,.f-select,.f-textarea{width:100%;padding:10px 13px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;transition:all 0.2s;}
.f-input:focus,.f-select:focus,.f-textarea:focus{border-color:var(--green3);background:white;box-shadow:0 0 0 3px rgba(82,168,85,0.1);}
.f-input::placeholder{color:var(--text4);}
.f-textarea{resize:vertical;min-height:75px;}
.f-hint{font-size:11px;color:var(--text4);margin-top:4px;font-family:'DM Mono',monospace;}
.f-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.f-error{font-size:12px;color:var(--danger);margin-top:4px;min-height:16px;}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}

/* PROFILE MODAL */
.profile-modal-header{display:flex;flex-direction:column;align-items:center;text-align:center;padding:24px;background:linear-gradient(135deg,var(--green6),var(--bg));border-radius:12px;margin-bottom:20px;}
.profile-avatar-big{width:80px;height:80px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;margin-bottom:14px;box-shadow:0 8px 24px rgba(45,106,47,0.3);}
.profile-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
.profile-stat{text-align:center;padding:12px;background:white;border-radius:10px;border:1px solid var(--border);}
.profile-stat-val{font-family:'Fraunces',serif;font-size:24px;font-weight:700;color:var(--green);}
.profile-stat-lbl{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;}

/* DAILY CHECK */
.daily-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}
.daily-card{background:white;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden;}
.dc-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--surface2);}
.dc-av{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;}
.dc-name{font-size:14px;font-weight:800;color:var(--text);}
.dc-sub{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;}
.dc-body{padding:14px 18px;}
.check-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(74,120,55,0.06);}
.check-item:last-child{border-bottom:none;}
.chk{width:18px;height:18px;border-radius:5px;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all 0.15s;background:white;}
.chk.checked{background:var(--green);border-color:var(--green);}
.chk.checked::after{content:'‚úì';font-size:10px;color:white;font-weight:800;}
.chk-label{font-size:12px;color:var(--text2);font-weight:500;flex:1;}
.chk-label.done{text-decoration:line-through;color:var(--text4);}
.carry-tag{font-size:9px;background:#fff3e0;color:#e65100;border:1px solid rgba(230,81,0,0.3);border-radius:8px;padding:1px 6px;font-family:'DM Mono',monospace;margin-left:4px;}
.act-list{display:flex;flex-direction:column;gap:8px;}
.act-item{display:flex;gap:12px;padding:14px 16px;background:white;border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);}
.act-ico{width:36px;height:36px;border-radius:10px;background:var(--green6);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.act-body{flex:1;}
.act-text{font-size:13px;color:var(--text);font-weight:600;}
.act-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.act-time{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:4px;}
.settings-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow-sm);margin-bottom:14px;}
.settings-head{font-size:14px;font-weight:800;color:var(--text);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.pass-cell{font-family:'DM Mono',monospace;font-size:11px;color:var(--text4);cursor:pointer;transition:color 0.15s;user-select:none;}
.pass-cell:hover{color:var(--green);}
.profile-big{display:flex;align-items:center;gap:20px;padding:20px;background:linear-gradient(135deg,var(--green6),var(--bg));border:1px solid var(--border2);border-radius:var(--radius);margin-bottom:8px;cursor:pointer;transition:all 0.2s;}
.profile-big:hover{box-shadow:var(--shadow);}
.pb-av{width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;box-shadow:0 4px 16px rgba(45,106,47,0.2);}
.pb-name{font-size:20px;font-weight:800;color:var(--text);}
.pb-role{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.ann-banner{padding:14px 18px;background:linear-gradient(135deg,var(--gold-bg),#fff9ed);border:1px solid rgba(184,134,11,0.2);border-radius:var(--radius-sm);display:flex;align-items:center;gap:12px;font-size:13px;color:var(--text2);font-weight:500;}
.empty-st{padding:48px;text-align:center;}
.empty-st .ei{font-size:40px;opacity:0.3;margin-bottom:10px;}
.empty-st p{font-size:13px;color:var(--text4);font-family:'DM Mono',monospace;}

/* NOTIFICATION POPUP */
.notif-popup{position:fixed;top:70px;right:16px;width:340px;background:white;border:1px solid var(--border2);border-radius:14px;box-shadow:var(--shadow-lg);z-index:600;display:none;overflow:hidden;}
.notif-popup.show{display:block;animation:slideDown 0.3s ease;}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.notif-popup-head{padding:12px 16px;background:var(--green6);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.notif-popup-title{font-size:13px;font-weight:800;color:var(--green);}
.notif-list{max-height:300px;overflow-y:auto;}
.notif-item{padding:12px 16px;border-bottom:1px solid rgba(74,120,55,0.05);display:flex;gap:10px;align-items:flex-start;}
.notif-item:last-child{border-bottom:none;}
.notif-item.unread{background:var(--green6);}
.notif-icon{width:32px;height:32px;border-radius:8px;background:var(--green6);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.notif-text{font-size:12px;font-weight:600;color:var(--text);}
.notif-time{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;}

/* TASK ASSIGN POPUP */
.task-notif-pop{position:fixed;bottom:80px;right:22px;width:320px;background:white;border:1px solid rgba(82,168,85,0.4);border-radius:14px;box-shadow:0 8px 32px rgba(45,106,47,0.25);z-index:800;padding:16px;transform:translateY(100px);opacity:0;transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);}
.task-notif-pop.show{transform:translateY(0);opacity:1;}
.tnp-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.tnp-icon{width:36px;height:36px;border-radius:10px;background:var(--green6);display:flex;align-items:center;justify-content:center;font-size:18px;}
.tnp-title{font-size:13px;font-weight:800;color:var(--green);}
.tnp-msg{font-size:12px;color:var(--text2);line-height:1.5;}
.tnp-close{position:absolute;top:10px;right:10px;cursor:pointer;font-size:14px;color:var(--text4);}

/* SIGNATURE PAD */
#sig-canvas{border:2px dashed var(--border2);border-radius:10px;cursor:crosshair;display:block;background:#fafff9;}
.sig-actions{display:flex;gap:8px;margin-top:8px;}

/* REPORT PAGE */
.report-section{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px;box-shadow:var(--shadow-sm);}
.report-section h3{font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--text);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.report-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
.rg-item{text-align:center;padding:14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);}
.rg-val{font-family:'Fraunces',serif;font-size:28px;font-weight:700;color:var(--green);}
.rg-lbl{font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:3px;letter-spacing:1px;text-transform:uppercase;}
.member-report-row{display:flex;align-items:center;gap:14px;padding:14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);margin-bottom:10px;}

/* PRINT STYLES */
@media print{
  body{background:white!important;}
  .topbar,.sidebar,.ph-actions,.modal-overlay,.toast,.db-indicator,.notif-popup,.task-notif-pop{display:none!important;}
  .app-layout{grid-template-columns:1fr!important;}
  .main{padding:0!important;}
  #print-report{display:block!important;}
}

.toast{position:fixed;bottom:22px;right:22px;padding:13px 20px;background:white;border:1px solid var(--border2);border-radius:12px;color:var(--green);font-size:13px;font-weight:600;z-index:999;box-shadow:var(--shadow-lg);transform:translateY(60px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);}
.toast.show{transform:translateY(0);opacity:1;}
.db-indicator{position:fixed;top:70px;right:16px;padding:5px 12px;border-radius:8px;font-size:10px;font-family:'DM Mono',monospace;z-index:500;opacity:0;transition:opacity 0.3s;}
.db-indicator.syncing{background:#e8f4fd;border:1px solid rgba(26,111,168,0.2);color:var(--info);opacity:1;}
.db-indicator.synced{background:var(--green6);border:1px solid var(--border2);color:var(--green);opacity:1;}
.work-timer{font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--green);text-align:center;padding:12px;background:var(--green6);border-radius:10px;margin:10px 0;}

/* CARRY FORWARD BANNER */
.carry-banner{padding:12px 16px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:1px solid rgba(230,81,0,0.3);border-radius:10px;display:flex;align-items:center;gap:10px;font-size:12px;color:#e65100;font-weight:600;margin-bottom:14px;}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:var(--green5);border-radius:4px;}
@media(max-width:900px){.app-layout{grid-template-columns:1fr;}.sidebar{display:none;}.stats-row{grid-template-columns:1fr 1fr;}.topbar-center{display:none;}}
</style>
</head>
<body>

<!-- CONFIG SCREEN -->
<div id="config-screen">
  <div class="config-card">
    <div class="config-logo">
      <div class="config-logo-icon"><img src="logo.png" alt="FicusAgentAI" onerror="this.parentElement.innerHTML='üåø'"></div>
      <div class="config-logo-text">FicusAgentAI</div>
    </div>
    <div class="config-title">‚òÅÔ∏è Supabase Configuration</div>
    <div class="config-sub">‡§è‡§ï‡§¶‡§æ‡§ö setup ‡§ï‡§∞‡§æ. Keys browser ‡§Æ‡§ß‡•ç‡§Ø‡•á save ‡§π‡•ã‡§§‡§æ‡§§.<br>Supabase.com ‚Üí Project ‚Üí Settings ‚Üí API ‡§µ‡§∞‡•Ç‡§® ‡§Æ‡§ø‡§≥‡§§‡§æ‡§§.</div>
    <div class="config-field">
      <label class="config-label">Supabase Project URL</label>
      <input class="config-input" id="cfg-url" placeholder="https://xxxxx.supabase.co" />
    </div>
    <div class="config-field">
      <label class="config-label">Supabase Anon Public Key</label>
      <input class="config-input" id="cfg-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
    </div>
    <div class="config-err" id="cfg-err"></div>
    <button class="config-btn" onclick="initSupabase()">üöÄ Connect to Supabase</button>
    <div class="config-note">‚ö† anon key safe ‡§Ü‡§π‡•á frontend ‡§∏‡§æ‡§†‡•Ä.<br>‚ùå Service Role key ‡§ï‡§ß‡•Ä‡§π‡•Ä ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡•Ç ‡§®‡§ï‡§æ!<br>‚úÖ Keys ‡§è‡§ï‡§¶‡§æ save ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§™‡•Å‡§®‡•ç‡§π‡§æ enter ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•Ä ‡§ó‡§∞‡§ú ‡§®‡§æ‡§π‡•Ä.</div>
  </div>
</div>

<!-- LOADING -->
<div id="loading-screen">
  <div class="loader"></div>
  <div class="loading-text" id="loading-text">Connecting to database...</div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-left">
      <div class="login-brand">
        <div class="brand-logo-wrap"><img src="logo.png" alt="FicusAgentAI" onerror="this.parentElement.style.background='linear-gradient(135deg,#2d6a2f,#3d8b40)';this.parentElement.innerHTML='<span style=font-size:40px;>üåø</span>'"></div>
        <h1>FicusAgentAI</h1>
        <p>AI Automation & App Building</p>
        <div class="login-features">
          <div class="feat-item"><span>üéØ</span> Task assignment & real-time tracking</div>
          <div class="feat-item"><span>‚è±</span> Work time tracking & productivity reports</div>
          <div class="feat-item"><span>üìä</span> Carryforward task management</div>
          <div class="feat-item"><span>‚òÅÔ∏è</span> Supabase powered ‚Äî real-time sync</div>
        </div>
      </div>
    </div>
    <div class="login-right">
      <div class="login-form-wrap">
        <div class="login-form-title">Welcome back üëã</div>
        <div class="login-form-sub">Sign in to your FicusAgentAI workspace</div>
        <div class="role-tabs">
          <div class="role-tab active" id="rtab-founder" onclick="selectRole('founder')">
            <div class="role-tab-icon"><img src="logo.png" style="width:24px;height:24px;border-radius:6px;" onerror="this.outerHTML='üåø'"></div>
            <div class="role-tab-name">Founder</div><div class="role-tab-sub">ADMIN ACCESS</div>
          </div>
          <div class="role-tab" id="rtab-employee" onclick="selectRole('employee')">
            <div class="role-tab-icon">üë§</div>
            <div class="role-tab-name">Employee</div><div class="role-tab-sub">TEAM MEMBER</div>
          </div>
        </div>
        <div id="emp-select-wrap" style="display:none;">
          <div class="field"><label class="field-label">Your Name</label>
            <select class="field-select" id="emp-selector"><option value="">‚Äî Select your name ‚Äî</option></select></div>
        </div>
        <div id="username-wrap">
          <div class="field"><label class="field-label">Username</label>
            <input class="field-input" type="text" id="login-username" placeholder="Enter username" /></div>
        </div>
        <div class="field"><label class="field-label">Password</label>
          <input class="field-input" type="password" id="login-password" placeholder="Enter password" />
          <div class="field-error" id="login-error"></div></div>
        <button class="login-submit" onclick="doLogin()">Sign In ‚Üí</button>
        <div class="login-hint" id="login-hint">Enter your credentials to continue</div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="topbar-logo">
        <div class="tb-icon"><img src="logo.png" alt="FA" onerror="this.parentElement.style.background='linear-gradient(135deg,#2d6a2f,#3d8b40)';this.outerHTML='<span style=font-size:16px;padding:8px;>üåø</span>'"></div>
        <span class="tb-brand">FicusAgentAI</span>
      </div>
      <span class="tb-badge" id="role-badge">FOUNDER</span>
    </div>
    <div class="topbar-center">
      <div class="search-bar">
        <span style="font-size:14px;color:var(--text4);">üîç</span>
        <input class="search-input" placeholder="Search tasks, projects, team..." id="search-input" oninput="handleSearch(this.value)" />
      </div>
    </div>
    <div class="topbar-right">
      <!-- Employee Online Timer -->
      <div id="online-btn-wrap" style="display:none;">
        <div class="online-badge" id="online-badge" onclick="toggleOnline()">
          <span class="pulse" id="online-pulse"></span>
          <span id="online-label">Go Online</span>
        </div>
      </div>
      <div class="watch">
        <div class="watch-time" id="watch-time">00:00:00</div>
        <div class="watch-date" id="watch-date">‚Äî</div>
      </div>
      <div class="notif-btn" id="notif-btn" onclick="toggleNotifPanel()">üîî<div class="notif-dot" id="notif-dot"></div></div>
      <div class="user-pill" onclick="openMyProfile()">
        <div class="u-avatar u-av-founder" id="top-avatar">S</div>
        <div><div class="u-name" id="top-name">Suraj</div><div class="u-role" id="top-role">FOUNDER</div></div>
      </div>
      <button class="logout-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="main">
      <div class="page" id="page-f-dashboard"></div>
      <div class="page" id="page-f-tasks"></div>
      <div class="page" id="page-f-team"></div>
      <div class="page" id="page-f-daily"></div>
      <div class="page" id="page-f-projects"></div>
      <div class="page" id="page-f-activity"></div>
      <div class="page" id="page-f-report"></div>
      <div class="page" id="page-f-settings"></div>
      <div class="page" id="page-e-dashboard"></div>
      <div class="page" id="page-e-tasks"></div>
      <div class="page" id="page-e-projects"></div>
      <div class="page" id="page-e-daily"></div>
      <div class="page" id="page-e-report"></div>
      <div class="page" id="page-e-settings"></div>
    </main>
  </div>
</div>

<!-- NOTIFICATION POPUP -->
<div class="notif-popup" id="notif-popup">
  <div class="notif-popup-head">
    <span class="notif-popup-title">üîî Notifications</span>
    <span style="font-size:11px;cursor:pointer;color:var(--green);" onclick="markAllRead()">Mark all read</span>
  </div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- TASK ASSIGNED POPUP -->
<div class="task-notif-pop" id="task-notif-pop">
  <div class="tnp-close" onclick="document.getElementById('task-notif-pop').classList.remove('show')">√ó</div>
  <div class="tnp-header"><div class="tnp-icon">üìã</div><div class="tnp-title">New Task Assigned!</div></div>
  <div class="tnp-msg" id="tnp-msg">You have a new task.</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-task">
  <div class="modal">
    <div class="modal-head"><div class="modal-title" id="task-modal-title">New Task</div><div class="close-btn" onclick="closeModal('modal-task')">√ó</div></div>
    <input type="hidden" id="tm-id" />
    <div class="f-group"><label class="f-label">Task Name *</label><input class="f-input" id="tm-name" placeholder="What needs to be done?" /></div>
    <div class="f-group"><label class="f-label">Description</label><textarea class="f-textarea" id="tm-desc" placeholder="Add details..."></textarea></div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Assign To</label><select class="f-select" id="tm-assign"></select></div>
      <div class="f-group"><label class="f-label">Priority</label>
        <select class="f-select" id="tm-priority"><option value="high">üî¥ High</option><option value="medium" selected>üü° Medium</option><option value="low">üü¢ Low</option></select></div>
    </div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Status</label>
        <select class="f-select" id="tm-status"><option value="pending">Pending</option><option value="inprogress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div>
      <div class="f-group"><label class="f-label">Deploy Status</label>
        <select class="f-select" id="tm-deploy"><option value="no">Not Deployed</option><option value="yes">Deployed ‚úì</option><option value="na">N/A</option></select></div>
    </div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Due Date</label><input class="f-input" type="date" id="tm-due" /></div>
      <div class="f-group"><label class="f-label">Project</label><select class="f-select" id="tm-project-sel"><option value="">‚Äî No Project ‚Äî</option></select></div>
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-task')">Cancel</button><button class="btn btn-primary" onclick="saveTask()">üíæ Save Task</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-member">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Add Team Member</div><div class="close-btn" onclick="closeModal('modal-member')">√ó</div></div>
    <div class="f-group"><label class="f-label">Full Name *</label><input class="f-input" id="mm-name" placeholder="Member's full name" /></div>
    <div class="f-group"><label class="f-label">Role / Designation</label><input class="f-input" id="mm-role" placeholder="e.g. Developer, Designer" /></div>
    <div class="f-group"><label class="f-label">Phone / WhatsApp</label><input class="f-input" id="mm-phone" placeholder="+91 XXXXX XXXXX" /></div>
    <div class="f-group"><label class="f-label">Email</label><input class="f-input" id="mm-email" placeholder="email@example.com" /></div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Username</label><input class="f-input" id="mm-username" placeholder="e.g. piyush" /></div>
      <div class="f-group"><label class="f-label">Password</label><input class="f-input" id="mm-password" placeholder="Set password" /><div class="f-hint">‚ö† Founder only visible</div></div>
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-member')">Cancel</button><button class="btn btn-primary" onclick="saveMember()">Add to Team</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-project">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">New Project</div><div class="close-btn" onclick="closeModal('modal-project')">√ó</div></div>
    <div class="f-group"><label class="f-label">Project Name *</label><input class="f-input" id="pm-name" placeholder="Project title" /></div>
    <div class="f-group"><label class="f-label">Description</label><textarea class="f-textarea" id="pm-desc" placeholder="Brief overview..."></textarea></div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Type</label><select class="f-select" id="pm-type"><option value="client">üè¢ Client</option><option value="internal">üåø Internal</option></select></div>
      <div class="f-group"><label class="f-label">Status</label><select class="f-select" id="pm-status"><option value="active">Active</option><option value="planning">Planning</option><option value="paused">On Hold</option><option value="done">Completed</option></select></div>
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-project')">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Create Project</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-edit-project">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Edit Project</div><div class="close-btn" onclick="closeModal('modal-edit-project')">√ó</div></div>
    <input type="hidden" id="ep-id" />
    <div class="f-group"><label class="f-label">Project Name *</label><input class="f-input" id="ep-name" /></div>
    <div class="f-group"><label class="f-label">Description</label><textarea class="f-textarea" id="ep-desc"></textarea></div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Type</label><select class="f-select" id="ep-type"><option value="client">üè¢ Client</option><option value="internal">üåø Internal</option></select></div>
      <div class="f-group"><label class="f-label">Status</label><select class="f-select" id="ep-status"><option value="active">Active</option><option value="planning">Planning</option><option value="paused">On Hold</option><option value="done">Completed</option></select></div>
    </div>
    <div class="f-group">
      <label class="f-label">Progress ‚Äî <span id="ep-prog-val">0</span>%</label>
      <input type="range" id="ep-progress" min="0" max="100" value="0" oninput="document.getElementById('ep-prog-val').textContent=this.value" style="width:100%;accent-color:var(--green);height:6px;cursor:pointer;margin-top:6px;" />
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-edit-project')">Cancel</button><button class="btn btn-primary" onclick="updateProject()">Save Changes</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-edit-member">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Edit Member</div><div class="close-btn" onclick="closeModal('modal-edit-member')">√ó</div></div>
    <input type="hidden" id="em-id" />
    <div class="f-group"><label class="f-label">Full Name</label><input class="f-input" id="em-name" /></div>
    <div class="f-group"><label class="f-label">Role / Designation</label><input class="f-input" id="em-role" /></div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Phone</label><input class="f-input" id="em-phone" /></div>
      <div class="f-group"><label class="f-label">Email</label><input class="f-input" id="em-email" /></div>
    </div>
    <div class="f-row">
      <div class="f-group"><label class="f-label">Username</label><input class="f-input" id="em-username" /></div>
      <div class="f-group"><label class="f-label">Reset Password</label><input class="f-input" id="em-password" placeholder="Leave blank to keep" /></div>
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-edit-member')">Cancel</button><button class="btn btn-primary" onclick="updateMember()">Save Changes</button></div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal-overlay" id="modal-profile">
  <div class="modal modal-wide">
    <div class="modal-head"><div class="modal-title" id="prof-modal-title">Profile</div><div class="close-btn" onclick="closeModal('modal-profile')">√ó</div></div>
    <div id="prof-modal-body"></div>
  </div>
</div>

<!-- PASSWORD MODALS -->
<div class="modal-overlay" id="modal-changepass">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">üîê Change Password</div><div class="close-btn" onclick="closeModal('modal-changepass')">√ó</div></div>
    <div style="padding:10px 14px;background:var(--green6);border:1px solid var(--border2);border-radius:9px;font-size:12px;color:var(--green2);font-family:'DM Mono',monospace;margin-bottom:16px;">Changing password for: <strong id="cp-user-display"></strong></div>
    <div class="f-group"><label class="f-label">Current Password</label><input class="f-input" type="password" id="cp-current" /></div>
    <div class="f-group"><label class="f-label">New Password</label><input class="f-input" type="password" id="cp-new" placeholder="Min 6 characters" /></div>
    <div class="f-group"><label class="f-label">Confirm New Password</label><input class="f-input" type="password" id="cp-confirm" /></div>
    <div class="f-error" id="cp-err"></div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-changepass')">Cancel</button><button class="btn btn-primary" onclick="changePassword()">Update Password</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-reset-pass">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">üîë Reset Employee Password</div><div class="close-btn" onclick="closeModal('modal-reset-pass')">√ó</div></div>
    <input type="hidden" id="rp-uid" />
    <div style="padding:10px 14px;background:var(--gold-bg);border:1px solid rgba(184,134,11,0.2);border-radius:9px;font-size:11px;color:var(--gold);font-family:'DM Mono',monospace;margin-bottom:14px;">‚ö† Founder can reset any employee password directly.</div>
    <div class="f-group"><label class="f-label">Employee</label><input class="f-input" id="rp-name" readonly style="background:var(--bg2);" /></div>
    <div class="f-group"><label class="f-label">New Password *</label><input class="f-input" type="text" id="rp-newpass" placeholder="Min 6 characters" /></div>
    <div class="f-group"><label class="f-label">Confirm Password *</label><input class="f-input" type="text" id="rp-confirm" /></div>
    <div class="f-error" id="rp-err"></div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal('modal-reset-pass')">Cancel</button><button class="btn btn-gold" onclick="founderResetPass()">üîë Reset Password</button></div>
  </div>
</div>

<!-- REPORT + SIGNATURE MODAL -->
<div class="modal-overlay" id="modal-sign">
  <div class="modal modal-wide">
    <div class="modal-head"><div class="modal-title">‚úçÔ∏è Sign & Download Report</div><div class="close-btn" onclick="closeModal('modal-sign')">√ó</div></div>
    <div style="margin-bottom:14px;font-size:13px;color:var(--text2);">Draw your signature below, then download the report as PDF.</div>
    <canvas id="sig-canvas" width="560" height="150"></canvas>
    <div class="sig-actions">
      <button class="btn btn-ghost btn-sm" onclick="clearSig()">üóë Clear</button>
      <button class="btn btn-primary" onclick="downloadReport()" style="margin-left:auto;">üì• Download PDF Report</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="db-indicator" id="db-indicator">‚òÅÔ∏è Syncing...</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CFG_KEY = 'ficus_supabase_cfg';
let sbClient = null;

function getSavedConfig(){try{return JSON.parse(localStorage.getItem(CFG_KEY)||'null');}catch(e){return null;}}
function saveConfig(url,key){localStorage.setItem(CFG_KEY,JSON.stringify({url,key}));}

async function initSupabase(url,key){
  const cfgErr=document.getElementById('cfg-err');
  if(!url&&!key){url=document.getElementById('cfg-url').value.trim();key=document.getElementById('cfg-key').value.trim();}
  if(!url||!key){if(cfgErr)cfgErr.textContent='‚ö† Both fields required!';return;}
  if(!url.includes('supabase.co')){if(cfgErr)cfgErr.textContent='‚ö† URL must contain supabase.co';return;}
  showLoading('Connecting to Supabase...');
  try{
    sbClient=supabase.createClient(url,key);
    const {error}=await sbClient.from('users').select('id').limit(1);
    if(error)throw error;
    saveConfig(url,key);hideConfig();await loadAllData();showLoginScreen();
  }catch(e){hideLoading();console.error(e);if(cfgErr)cfgErr.textContent='‚úó Connection failed: '+(e.message||'Check URL & key');}
}

window.addEventListener('load',async()=>{
  const cfg=getSavedConfig();
  if(cfg&&cfg.url&&cfg.key){
    hideConfig();showLoading('Loading workspace...');
    try{
      sbClient=supabase.createClient(cfg.url,cfg.key);
      const {error}=await sbClient.from('users').select('id').limit(1);
      if(error)throw error;
      await loadAllData();showLoginScreen();
    }catch(e){hideLoading();showConfig();localStorage.removeItem(CFG_KEY);}
  }
});

function hideConfig(){document.getElementById('config-screen').style.display='none';}
function showConfig(){document.getElementById('config-screen').style.display='flex';}
function showLoading(msg='Loading...'){document.getElementById('loading-text').textContent=msg;document.getElementById('loading-screen').style.display='flex';}
function hideLoading(){document.getElementById('loading-screen').style.display='none';}
function showLoginScreen(){hideLoading();document.getElementById('login-screen').style.display='flex';populateEmpSel();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S={me:null,role:null,users:[],tasks:[],projects:[],activity:[],notifications:[],workSessions:[],filter:'all',onlineActive:false,onlineStart:null,workTimerInterval:null,currentReportUser:null};

async function loadAllData(){
  showLoading('Loading data...');
  try{
    const [usersRes,tasksRes,projectsRes,activityRes,notifRes,sessionsRes]=await Promise.all([
      sbClient.from('users').select('*').order('created_at'),
      sbClient.from('tasks').select('*').order('created_at',{ascending:false}),
      sbClient.from('projects').select('*').order('created_at'),
      sbClient.from('activity').select('*').order('time',{ascending:false}).limit(100),
      sbClient.from('notifications').select('*').order('created_at',{ascending:false}).limit(50),
      sbClient.from('work_sessions').select('*').order('start_time',{ascending:false}).limit(200),
    ]);
    S.users=usersRes.data||[];
    S.tasks=tasksRes.data||[];
    S.projects=projectsRes.data||[];
    S.activity=(activityRes.data||[]).map(a=>({...a,time:new Date(a.time)}));
    S.notifications=notifRes.data||[];
    S.workSessions=sessionsRes.data||[];
  }catch(e){console.error('Load error:',e);showToast('‚ö† Data load failed!');}
  hideLoading();
}

async function dbSave(table,data){
  showDbIndicator('syncing');
  try{const{error}=await sbClient.from(table).upsert(data);if(error)throw error;showDbIndicator('synced');return true;}
  catch(e){console.error('Save error:',e);showToast('‚ö† Sync failed: '+e.message);showDbIndicator('');return false;}
}
async function dbDelete(table,id){
  showDbIndicator('syncing');
  try{const{error}=await sbClient.from(table).delete().eq('id',id);if(error)throw error;showDbIndicator('synced');return true;}
  catch(e){console.error('Delete error:',e);showToast('‚ö† Delete failed!');showDbIndicator('');return false;}
}
async function addAct(text,sub,icon='üìå'){
  const entry={text,sub:sub||'',icon,time:new Date().toISOString()};
  try{await sbClient.from('activity').insert(entry);}catch(e){}
  S.activity.unshift({...entry,time:new Date()});
}

// Real-time subscription
function subscribeRealtime(){
  if(!sbClient)return;
  sbClient.channel('db-changes')
    .on('postgres_changes',{event:'*',schema:'public',table:'tasks'},async(payload)=>{
      await syncTasks();
      // Notify employee if new task assigned to them
      if(payload.eventType==='INSERT'&&S.me&&payload.new.assign_to===S.me.name){
        showTaskNotifPop(`"${payload.new.name}" has been assigned to you!`);
        await addNotif(`New task: "${payload.new.name}"`,S.me.id,'üìã');
      }
      refreshCurrentPage();updateNavCounts();
    })
    .on('postgres_changes',{event:'*',schema:'public',table:'users'},async()=>{await syncUsers();refreshCurrentPage();})
    .on('postgres_changes',{event:'*',schema:'public',table:'projects'},async()=>{await syncProjects();refreshCurrentPage();})
    .on('postgres_changes',{event:'*',schema:'public',table:'notifications'},async(payload)=>{
      if(payload.eventType==='INSERT'&&S.me&&payload.new.for_user_id===S.me.id){
        S.notifications.unshift(payload.new);updateNotifBadge();
        if(payload.new.type==='task_assigned')showTaskNotifPop(payload.new.message);
      }
    })
    .subscribe();
}

async function syncTasks(){try{const{data}=await sbClient.from('tasks').select('*').order('created_at',{ascending:false});S.tasks=data||[];}catch(e){}}
async function syncUsers(){try{const{data}=await sbClient.from('users').select('*').order('created_at');S.users=data||[];}catch(e){}}
async function syncProjects(){try{const{data}=await sbClient.from('projects').select('*').order('created_at');S.projects=data||[];}catch(e){}}

async function addNotif(message,forUserId,type='info'){
  const n={id:genId(),message,for_user_id:forUserId,type,read:false,created_at:new Date().toISOString()};
  try{await sbClient.from('notifications').insert(n);}catch(e){}
  if(S.me&&S.me.id===forUserId){S.notifications.unshift(n);updateNotifBadge();}
}

function updateNotifBadge(){
  const unread=S.notifications.filter(n=>n.for_user_id===S.me?.id&&!n.read).length;
  const btn=document.getElementById('notif-btn');
  if(btn)btn.classList.toggle('has-notif',unread>0);
}
async function markAllRead(){
  S.notifications.filter(n=>n.for_user_id===S.me?.id&&!n.read).forEach(n=>n.read=true);
  try{await sbClient.from('notifications').update({read:true}).eq('for_user_id',S.me.id).eq('read',false);}catch(e){}
  updateNotifBadge();renderNotifPanel();
}

function showTaskNotifPop(msg){
  const el=document.getElementById('task-notif-pop');
  document.getElementById('tnp-msg').textContent=msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),6000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tick(){
  const now=new Date();
  const wt=document.getElementById('watch-time');const wd=document.getElementById('watch-date');
  if(wt)wt.textContent=now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  if(wd)wd.textContent=now.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short'}).toUpperCase();
}
setInterval(tick,1000);tick();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORK SESSION / ONLINE TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleOnline(){
  if(S.onlineActive){stopOnline();}else{startOnline();}
}
async function startOnline(){
  S.onlineActive=true;S.onlineStart=new Date();
  const badge=document.getElementById('online-badge');
  const label=document.getElementById('online-label');
  if(badge)badge.style.background='var(--success)';
  if(badge)badge.style.color='white';
  if(label)label.textContent='00:00:00';
  S.workTimerInterval=setInterval(()=>{
    if(!S.onlineStart)return;
    const diff=Math.floor((new Date()-S.onlineStart)/1000);
    const h=String(Math.floor(diff/3600)).padStart(2,'0');
    const m=String(Math.floor((diff%3600)/60)).padStart(2,'0');
    const sec=String(diff%60).padStart(2,'0');
    const lbl=document.getElementById('online-label');
    if(lbl)lbl.textContent=`${h}:${m}:${sec}`;
  },1000);
  await addAct(`${S.me.name} went online`,S.me.title,'üü¢');
  showToast('üü¢ You are now Online!');
  // Save session start
  S.currentSession={id:genId(),user_id:S.me.id,user_name:S.me.name,date:new Date().toISOString().split('T')[0],start_time:S.onlineStart.toISOString(),end_time:null,duration_minutes:0};
  await dbSave('work_sessions',S.currentSession);
}
async function stopOnline(){
  if(!S.onlineActive)return;
  S.onlineActive=false;
  clearInterval(S.workTimerInterval);
  const endTime=new Date();
  const dur=Math.floor((endTime-S.onlineStart)/60000);
  const badge=document.getElementById('online-badge');
  const label=document.getElementById('online-label');
  if(badge)badge.style.background='var(--green6)';if(badge)badge.style.color='var(--green)';
  if(label)label.textContent='Go Online';
  if(S.currentSession){
    S.currentSession.end_time=endTime.toISOString();
    S.currentSession.duration_minutes=dur;
    await dbSave('work_sessions',S.currentSession);
    S.workSessions.unshift(S.currentSession);
  }
  await addAct(`${S.me.name} went offline (${dur} min)`,S.me.title,'üî¥');
  showToast(`Session saved: ${dur} minutes worked.`);
  S.onlineStart=null;S.currentSession=null;
}
async function doLogout(){
  if(S.onlineActive){await stopOnline();}
  S.me=null;S.role=null;S.filter='all';
  document.getElementById('app').style.display='none';
  await loadAllData();showLoginScreen();
  document.getElementById('login-password').value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lRole='founder';
function selectRole(r){
  lRole=r;
  ['founder','employee'].forEach(x=>document.getElementById('rtab-'+x).classList.toggle('active',x===r));
  document.getElementById('emp-select-wrap').style.display=r==='employee'?'block':'none';
  document.getElementById('username-wrap').style.display=r==='founder'?'block':'none';
  document.getElementById('login-error').textContent='';
  if(r==='employee')populateEmpSel();
}
function populateEmpSel(){
  const sel=document.getElementById('emp-selector');if(!sel)return;
  sel.innerHTML='<option value="">‚Äî Select your name ‚Äî</option>';
  S.users.filter(u=>u.role==='employee').forEach(u=>{const o=document.createElement('option');o.value=u.id;o.textContent=u.name+' ‚Äî '+u.title;sel.appendChild(o);});
}
async function doLogin(){
  const pw=document.getElementById('login-password').value;
  const err=document.getElementById('login-error');err.textContent='';
  if(!pw){err.textContent='Password required.';return;}
  if(lRole==='founder'){
    const un=document.getElementById('login-username').value.trim().toLowerCase();
    const u=S.users.find(u=>u.role==='founder'&&u.username.toLowerCase()===un&&u.password===pw);
    if(!u){err.textContent='Invalid username or password.';return;}
    S.me=u;S.role='founder';
  }else{
    const uid=document.getElementById('emp-selector').value;
    if(!uid){err.textContent='Please select your name.';return;}
    const u=S.users.find(u=>u.id===uid);
    if(!u||u.password!==pw){err.textContent='Incorrect password.';return;}
    S.me=u;S.role='employee';
  }
  document.getElementById('login-screen').style.display='none';
  launch();
}
document.getElementById('login-password')?.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH & SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launch(){
  document.getElementById('app').style.display='block';
  const u=S.me;
  document.getElementById('top-name').textContent=u.name;
  document.getElementById('top-avatar').textContent=u.name[0];
  document.getElementById('top-avatar').className='u-avatar '+(S.role==='founder'?'u-av-founder':'u-av-emp');
  document.getElementById('top-role').textContent=S.role==='founder'?'FOUNDER & CEO':u.title.toUpperCase();
  document.getElementById('role-badge').textContent=S.role==='founder'?'üåø FOUNDER':'üë§ '+u.title.toUpperCase();
  document.getElementById('role-badge').className='tb-badge '+(S.role==='founder'?'tb-badge-founder':'tb-badge-emp');
  // Show online button for employees
  const obw=document.getElementById('online-btn-wrap');
  if(obw)obw.style.display=S.role==='employee'?'flex':'none';
  buildSidebar();
  updateNotifBadge();
  subscribeRealtime();
  showPage(S.role==='founder'?'f-dashboard':'e-dashboard');
  // Check carryforward tasks
  if(S.role==='employee')checkCarryForward();
  else checkAllCarryForward();
}

function buildSidebar(){
  const sb=document.getElementById('sidebar');
  if(S.role==='founder'){
    const overdueCount=S.tasks.filter(t=>isOverdue(t)).length;
    sb.innerHTML=`
      <div class="nav-label" style="margin-top:4px;">Overview</div>
      <div class="nav-item" id="nav-f-dashboard" onclick="showPage('f-dashboard')"><div class="nav-icon-wrap">‚¨°</div> Dashboard</div>
      <div class="nav-item" id="nav-f-tasks" onclick="showPage('f-tasks')"><div class="nav-icon-wrap">‚úì</div> All Tasks <span class="nav-count" id="nc-tasks">${S.tasks.length}</span></div>
      <div class="nav-label">Team</div>
      <div class="nav-item" id="nav-f-team" onclick="showPage('f-team')"><div class="nav-icon-wrap">üë•</div> Team Members</div>
      <div class="nav-item" id="nav-f-daily" onclick="showPage('f-daily')"><div class="nav-icon-wrap">üìÖ</div> Daily Check ${overdueCount>0?`<span class="nav-count red">${overdueCount}</span>`:''}</div>
      <div class="nav-label">Work</div>
      <div class="nav-item" id="nav-f-projects" onclick="showPage('f-projects')"><div class="nav-icon-wrap">üìÅ</div> Projects <span class="nav-count">${S.projects.length}</span></div>
      <div class="nav-item" id="nav-f-activity" onclick="showPage('f-activity')"><div class="nav-icon-wrap">üìã</div> Activity Log</div>
      <div class="nav-item" id="nav-f-report" onclick="showPage('f-report')"><div class="nav-icon-wrap">üìä</div> Productivity Report</div>
      <div class="nav-label">Admin</div>
      <div class="nav-item" id="nav-f-settings" onclick="showPage('f-settings')"><div class="nav-icon-wrap">‚öô</div> Settings</div>
      <div class="sidebar-divider"></div>
      <div class="nav-label">Team</div>
      ${S.users.filter(u=>u.role==='employee').map(u=>`
        <div class="sm-card" onclick="openProfileModal('${u.id}')">
          <div class="sm-av" style="background:${u.bg};color:white;">${u.name[0]}</div>
          <div class="sm-info"><div class="sm-name">${u.name}</div><div class="sm-role">${u.title}</div></div>
          <div class="sm-dot ${isUserOnline(u.id)?'dot-on':'dot-off'}"></div>
        </div>`).join('')}`;
  }else{
    const myOverdue=S.tasks.filter(t=>t.assign_to===S.me.name&&isOverdue(t)).length;
    sb.innerHTML=`
      <div class="nav-label" style="margin-top:4px;">My Workspace</div>
      <div class="nav-item" id="nav-e-dashboard" onclick="showPage('e-dashboard')"><div class="nav-icon-wrap">‚¨°</div> Dashboard</div>
      <div class="nav-item" id="nav-e-tasks" onclick="showPage('e-tasks')"><div class="nav-icon-wrap">‚úì</div> My Tasks ${myOverdue>0?`<span class="nav-count red">${myOverdue}</span>`:''}</div>
      <div class="nav-item" id="nav-e-projects" onclick="showPage('e-projects')"><div class="nav-icon-wrap">üìÅ</div> Projects</div>
      <div class="nav-item" id="nav-e-daily" onclick="showPage('e-daily')"><div class="nav-icon-wrap">üìÖ</div> Daily Checklist</div>
      <div class="nav-item" id="nav-e-report" onclick="showPage('e-report')"><div class="nav-icon-wrap">üìä</div> My Report</div>
      <div class="sidebar-divider"></div>
      <div class="nav-item" id="nav-e-settings" onclick="showPage('e-settings')"><div class="nav-icon-wrap">‚öô</div> Settings</div>`;
  }
}

function updateNavCounts(){
  const nc=document.getElementById('nc-tasks');if(nc)nc.textContent=S.tasks.length;
  buildSidebar();
  const activeNv=document.querySelector('.nav-item.active');
  if(activeNv){const p=activeNv.id.replace('nav-','');document.getElementById('nav-'+p)?.classList.add('active');}
}

function isUserOnline(uid){
  return S.workSessions.some(s=>s.user_id===uid&&!s.end_time&&new Date()-new Date(s.start_time)<3600000);
}

function showPage(p){
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  const pg=document.getElementById('page-'+p);if(pg){pg.classList.add('active');renderPage(p);}
  const nv=document.getElementById('nav-'+p);if(nv)nv.classList.add('active');
  document.getElementById('notif-popup').classList.remove('show');
}
function renderPage(p){
  const R={'f-dashboard':rFounderDash,'f-tasks':rFounderTasks,'f-team':rFounderTeam,'f-daily':rFounderDaily,'f-projects':rFounderProjects,'f-activity':rFounderActivity,'f-report':rFounderReport,'f-settings':rFounderSettings,'e-dashboard':rEmpDash,'e-tasks':rEmpTasks,'e-projects':rEmpProjects,'e-daily':rEmpDaily,'e-report':rEmpReport,'e-settings':rEmpSettings};
  if(R[p])R[p]();
}
function refreshCurrentPage(){const a=document.querySelector('.page.active');if(a)renderPage(a.id.replace('page-',''));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function statusBadge(s){const m={done:['b-done','‚úì Done'],inprogress:['b-prog','‚ü≥ In Progress'],pending:['b-pend','‚óå Pending'],blocked:['b-block','‚äó Blocked']};const[c,l]=m[s]||m.pending;return`<span class="badge ${c}">${l}</span>`;}
function deployBadge(d){if(d==='yes')return'<span class="badge b-dep">üöÄ Deployed</span>';if(d==='no')return'<span class="badge b-ndep">‚úó Not Yet</span>';return'<span class="badge b-na">‚Äî N/A</span>';}
function prioBadge(p){const c=p==='high'?'ph-dot':p==='low'?'pl-dot':'pm-dot';return`<span class="prio"><span class="pd ${c}"></span>${p==='high'?'High':p==='low'?'Low':'Medium'}</span>`;}
function fmtDate(d){return d?new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short'}):'‚Äî';}
function today(){return new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});}
function getGreeting(){const h=new Date().getHours();return h<12?'morning':h<17?'afternoon':'evening';}
function genId(){return 'id'+Date.now()+Math.random().toString(36).substr(2,5);}
function todayStr(){return new Date().toISOString().split('T')[0];}

function isOverdue(t){
  if(!t.due_date||t.status==='done')return false;
  const dd=new Date(t.due_date);dd.setHours(0,0,0,0);
  const now=new Date();now.setHours(0,0,0,0);
  return dd<now;
}
function isCarryForward(t){return isOverdue(t)&&t.status!=='done';}

function checkCarryForward(){
  const cf=S.tasks.filter(t=>t.assign_to===S.me?.name&&isCarryForward(t));
  if(cf.length>0)showToast(`‚ö† ${cf.length} carried-forward task(s) need attention!`);
}
function checkAllCarryForward(){
  const cf=S.tasks.filter(t=>isCarryForward(t));
  if(cf.length>0)showToast(`‚ö† ${cf.length} overdue task(s) across team!`);
}

// Work time helpers
function getTotalWorkMinutes(userId){
  return S.workSessions.filter(s=>s.user_id===userId&&s.duration_minutes>0).reduce((a,s)=>a+(s.duration_minutes||0),0);
}
function getTodayWorkMinutes(userId){
  const td=todayStr();
  return S.workSessions.filter(s=>s.user_id===userId&&s.date===td&&s.duration_minutes>0).reduce((a,s)=>a+(s.duration_minutes||0),0);
}
function fmtDuration(min){
  if(min<60)return`${min}m`;
  return`${Math.floor(min/60)}h ${min%60}m`;
}

function taskTable(tasks,founder=false){
  if(!tasks.length)return`<div class="empty-st"><div class="ei">üìã</div><p>No tasks found.</p></div>`;
  const now=new Date();now.setHours(0,0,0,0);
  return`<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Task</th><th>Assigned</th><th>Status</th><th>Deploy</th><th>Priority</th><th>Due</th>${founder?'<th>Actions</th>':''}</tr></thead><tbody>
  ${tasks.map(t=>{
    const cf=isCarryForward(t);
    const overdue=isOverdue(t);
    const dueHtml=t.due_date?`<span style="font-family:'DM Mono',monospace;font-size:11px;${overdue?'color:var(--danger);font-weight:700;':'color:var(--text4);'}">${overdue?'‚ö† ':''}${fmtDate(t.due_date)}</span><br>${cf?'<span class="badge b-carry">‚Ü© Carried Forward</span>':''}`:`<span style="color:var(--text4);font-family:'DM Mono',monospace;font-size:11px;">‚Äî</span>`;
    return`<tr style="${cf?'background:rgba(230,81,0,0.04);':overdue?'background:rgba(192,57,43,0.03);':''}">
    <td><div class="td-name">${t.name}</div>${t.project?`<div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;">üìÅ ${t.project}</div>`:''}</td>
    <td><span class="a-chip">${t.assign_to}</span></td>
    <td>${statusBadge(t.status)}</td><td>${deployBadge(t.deploy)}</td><td>${prioBadge(t.priority)}</td>
    <td>${dueHtml}</td>
    ${founder?`<td><div class="r-actions"><button class="r-btn" onclick="openTaskModal('${t.id}')">‚úè Edit</button><button class="r-btn del" onclick="deleteTask('${t.id}')">üóë</button></div></td>`:''}
    </tr>`;
  }).join('')}</tbody></table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATION PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleNotifPanel(){
  const panel=document.getElementById('notif-popup');
  const isOpen=panel.classList.contains('show');
  if(isOpen){panel.classList.remove('show');return;}
  renderNotifPanel();panel.classList.add('show');
}
function renderNotifPanel(){
  const list=document.getElementById('notif-list');
  const myNotifs=S.notifications.filter(n=>n.for_user_id===S.me?.id);
  if(!myNotifs.length){list.innerHTML='<div class="empty-st"><div class="ei" style="font-size:24px;">üîî</div><p>No notifications</p></div>';return;}
  list.innerHTML=myNotifs.slice(0,20).map(n=>`
    <div class="notif-item ${n.read?'':'unread'}">
      <div class="notif-icon">${n.type==='task_assigned'?'üìã':'‚ÑπÔ∏è'}</div>
      <div><div class="notif-text">${n.message}</div>
      <div class="notif-time">${new Date(n.created_at).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})} ¬∑ ${new Date(n.created_at).toLocaleDateString('en-IN',{day:'2-digit',month:'short'})}</div></div>
    </div>`).join('');
}
document.addEventListener('click',e=>{
  const panel=document.getElementById('notif-popup');
  const btn=document.getElementById('notif-btn');
  if(panel&&!panel.contains(e.target)&&btn&&!btn.contains(e.target))panel.classList.remove('show');
});

function showDbIndicator(state){
  const el=document.getElementById('db-indicator');if(!el)return;
  el.className='db-indicator';
  if(state==='syncing'){el.textContent='‚òÅÔ∏è Syncing...';el.classList.add('syncing');}
  else if(state==='synced'){el.textContent='‚úÖ Saved to Cloud';el.classList.add('synced');clearTimeout(el._t);el._t=setTimeout(()=>{el.className='db-indicator';},2000);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOUNDER PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rFounderDash(){
  const el=document.getElementById('page-f-dashboard');
  const total=S.tasks.length,done=S.tasks.filter(t=>t.status==='done').length,inprog=S.tasks.filter(t=>t.status==='inprogress').length,deployed=S.tasks.filter(t=>t.deploy==='yes').length;
  const totalProj=S.projects.length,activeProj=S.projects.filter(p=>p.status==='active').length;
  const emps=S.users.filter(u=>u.role==='employee');
  const overdueAll=S.tasks.filter(t=>isCarryForward(t)).length;
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Good ${getGreeting()}, ${S.me.name} üëã</div><div class="ph-sub">${today().toUpperCase()}</div></div>
  <div class="ph-actions"><button class="btn btn-outline" onclick="openModal('modal-member')">+ Add Member</button><button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button></div></div>
  ${overdueAll>0?`<div class="carry-banner"><span>‚ö†</span><span>${overdueAll} task(s) are <strong>carried forward</strong> from previous days ‚Äî need urgent attention!</span></div>`:''}
  <div class="stats-row-5">
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">üìã</div><div class="stat-label">Total Tasks</div><div class="stat-value">${total}</div><div class="stat-sub">All members</div></div>
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">‚úÖ</div><div class="stat-label">Completed</div><div class="stat-value">${done}</div><div class="stat-sub">${total?Math.round(done/total*100):0}% rate</div></div>
    <div class="stat-card sc-blue"><div class="stat-icon-wrap sic-blue">‚ü≥</div><div class="stat-label">In Progress</div><div class="stat-value">${inprog}</div><div class="stat-sub">Active now</div></div>
    <div class="stat-card sc-gold"><div class="stat-icon-wrap sic-gold">üöÄ</div><div class="stat-label">Deployed</div><div class="stat-value">${deployed}</div><div class="stat-sub">Live</div></div>
    <div class="stat-card sc-purple"><div class="stat-icon-wrap sic-purple">üìÅ</div><div class="stat-label">Projects</div><div class="stat-value">${totalProj}</div><div class="stat-sub">${activeProj} active</div></div>
  </div>
  <!-- Projects Mini Grid -->
  ${S.projects.length?`<div class="sec-head"><div class="sec-title">Projects Overview</div><button class="btn btn-ghost btn-sm" onclick="showPage('f-projects')">View All ‚Üí</button></div>
  <div class="proj-grid" style="margin-bottom:24px;">${S.projects.slice(0,4).map(p=>{const pt=S.tasks.filter(t=>t.project===p.name),pd=pt.filter(t=>t.status==='done').length,sc={active:'b-done',planning:'b-pend',paused:'b-block',done:'b-na'}[p.status]||'b-na';
  return`<div class="proj-card"><div class="pc-header"><div class="pc-name">${p.name}</div><span class="badge ${p.type==='client'?'b-client':'b-internal'}">${p.type==='client'?'CLIENT':'INTERNAL'}</span></div>
  <div style="margin-bottom:8px;"><span class="badge ${sc}">${p.status.toUpperCase()}</span></div>
  <div class="prog-bar"><div class="prog-fill" style="width:${p.progress}%"></div></div>
  <div class="prog-labels"><span>${pd}/${pt.length} tasks</span><span style="font-weight:700;">${p.progress}%</span></div></div>`;}).join('')}</div>`:``}
  ${emps.length?`<div class="sec-head"><div class="sec-title">Team Overview</div></div>
  <div class="team-grid">${emps.map(u=>{const ut=S.tasks.filter(t=>t.assign_to===u.name),ud=ut.filter(t=>t.status==='done').length,udep=ut.filter(t=>t.deploy==='yes').length,up=ut.filter(t=>t.status==='pending').length,pct=ut.length?Math.round(ud/ut.length*100):0,tdw=getTodayWorkMinutes(u.id);
  return`<div class="team-card" onclick="openProfileModal('${u.id}')" style="cursor:pointer;">
  <div class="tc-top"><div class="tc-av" style="background:${u.bg};color:white;">${u.name[0]}</div>
  <div><div class="tc-name">${u.name}</div><div class="tc-role">${u.title}</div></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:5px;"><div class="sm-dot ${isUserOnline(u.id)?'dot-on':'dot-off'}"></div><span style="font-size:10px;color:${isUserOnline(u.id)?'var(--success)':'var(--text4)'};font-family:'DM Mono',monospace;">${isUserOnline(u.id)?'ONLINE':'OFFLINE'}</span></div></div>
  <div class="tc-stats">
    <div class="tc-s"><div class="tc-sv" style="color:var(--success);">${ud}</div><div class="tc-sl">Done</div></div>
    <div class="tc-s"><div class="tc-sv" style="color:var(--gold);">${udep}</div><div class="tc-sl">Deployed</div></div>
    <div class="tc-s"><div class="tc-sv" style="color:var(--warn);">${up}</div><div class="tc-sl">Pending</div></div>
  </div>
  ${tdw>0?`<div style="font-size:10px;color:var(--green);font-family:'DM Mono',monospace;margin-bottom:8px;text-align:center;">‚è± Today: ${fmtDuration(tdw)}</div>`:''}
  <div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
  <div class="prog-labels"><span>Progress</span><span>${pct}%</span></div></div>`;}).join('')}</div>`:``}
  <div class="sec-head"><div class="sec-title">Recent Tasks</div><button class="btn btn-ghost btn-sm" onclick="showPage('f-tasks')">View All ‚Üí</button></div>
  ${taskTable(S.tasks.slice(0,5),true)}`;
}

function rFounderTasks(){
  const el=document.getElementById('page-f-tasks');
  const memberNames=S.users.map(u=>u.name);
  const allCount=S.tasks.length;
  const pendCount=S.tasks.filter(t=>t.status==='pending').length;
  const progCount=S.tasks.filter(t=>t.status==='inprogress').length;
  const doneCount=S.tasks.filter(t=>t.status==='done').length;
  const blockCount=S.tasks.filter(t=>t.status==='blocked').length;
  const cfCount=S.tasks.filter(t=>isCarryForward(t)).length;
  const filters=[
    {key:'all',label:`All`,count:allCount},
    {key:'pending',label:'Pending',count:pendCount},
    {key:'inprogress',label:'In Progress',count:progCount},
    {key:'done',label:'Done',count:doneCount},
    {key:'blocked',label:'Blocked',count:blockCount},
    {key:'carryforward',label:'‚Ü© Carryforward',count:cfCount},
    ...memberNames.map(n=>({key:n,label:n,count:S.tasks.filter(t=>t.assign_to===n).length}))
  ];
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Task Manager</div><div class="ph-sub">ASSIGN ¬∑ TRACK ¬∑ MONITOR</div></div><button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center;">
    <span style="font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;">Filter:</span>
    ${filters.map(f=>{const active=S.filter===f.key;return`<button class="btn btn-ghost btn-sm" onclick="setFilter('${f.key}')" style="${active?'background:var(--green6);border-color:var(--border2);color:var(--green);font-weight:800;':''}">${f.label} <span style="font-size:10px;opacity:0.7;">(${f.count})</span></button>`;}).join('')}
  </div>
  <div style="font-size:12px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:10px;">${getFiltered().length} tasks shown</div>
  ${taskTable(getFiltered(),true)}`;
}
function setFilter(f){S.filter=f;rFounderTasks();}
function getFiltered(){
  if(S.filter==='carryforward')return S.tasks.filter(t=>isCarryForward(t));
  if(S.filter==='all')return S.tasks;
  if(['pending','inprogress','done','blocked'].includes(S.filter))return S.tasks.filter(t=>t.status===S.filter);
  return S.tasks.filter(t=>t.assign_to===S.filter);
}

function rFounderTeam(){
  const el=document.getElementById('page-f-team');
  const emps=S.users.filter(u=>u.role==='employee');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Team Members</div><div class="ph-sub">MANAGE YOUR TEAM</div></div><button class="btn btn-primary" onclick="openModal('modal-member')">+ Add Member</button></div>
  <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Member</th><th>Username</th><th>Password</th><th>Tasks</th><th>Done</th><th>Today's Time</th><th>Status</th><th>Actions</th></tr></thead><tbody>
  ${emps.length?emps.map(u=>{const ut=S.tasks.filter(t=>t.assign_to===u.name),ud=ut.filter(t=>t.status==='done').length,udep=ut.filter(t=>t.deploy==='yes').length,tdw=getTodayWorkMinutes(u.id),online=isUserOnline(u.id);
  return`<tr><td><div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="openProfileModal('${u.id}')"><div style="width:34px;height:34px;border-radius:10px;background:${u.bg};color:white;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;">${u.name[0]}</div><div><div class="td-name">${u.name}</div><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;">${u.title}</div></div></div></td>
  <td><span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">@${u.username}</span></td>
  <td><span class="pass-cell" id="pc-${u.id}" onclick="revealPass('${u.id}')" title="Click to reveal">‚óè‚óè‚óè‚óè‚óè‚óè üëÅ</span></td>
  <td style="font-family:'DM Mono',monospace;">${ut.length}</td>
  <td style="color:var(--success);font-family:'DM Mono',monospace;font-weight:700;">${ud}</td>
  <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--info);">${tdw>0?fmtDuration(tdw):'‚Äî'}</td>
  <td><span class="badge ${online?'b-done':'b-na'}">${online?'üü¢ Online':'‚≠ò Offline'}</span></td>
  <td><div class="r-actions"><button class="r-btn" onclick="openProfileModal('${u.id}')">üëÅ View</button><button class="r-btn" onclick="openEditMember('${u.id}')">‚úè</button><button class="r-btn" onclick="openResetPass('${u.id}')" style="color:var(--gold);border-color:rgba(184,134,11,0.3);">üîë</button><button class="r-btn del" onclick="removeMember('${u.id}')">üóë</button></div></td></tr>`;}).join(''):'<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text4);">No team members yet.</td></tr>'}
  </tbody></table></div>`;
}

function rFounderDaily(){
  const el=document.getElementById('page-f-daily');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Daily Workflow</div><div class="ph-sub">${today().toUpperCase()}</div></div></div><div class="daily-grid">${S.users.map(u=>dailyCard(u)).join('')}</div>`;
}
function dailyCard(u){
  const tasks=S.tasks.filter(t=>t.assign_to===u.name);
  const done=tasks.filter(t=>t.status==='done').length,pct=tasks.length?Math.round(done/tasks.length*100):0;
  const isFounderUser=u.role==='founder';
  const items=tasks.map(t=>{
    const cf=isCarryForward(t);
    return`<div class="check-item"><div class="chk ${t.status==='done'?'checked':''}" onclick="toggleDone('${t.id}')"></div>
    <span class="chk-label ${t.status==='done'?'done':''}">${t.name}${cf?'<span class="carry-tag">‚Ü© Carry</span>':''}</span>
    ${t.deploy==='yes'?'<span style="font-size:14px;margin-left:auto;">üöÄ</span>':''}
    ${cf?`<span style="font-size:10px;color:#e65100;margin-left:4px;">(Due: ${fmtDate(t.due_date)})</span>`:''}
    </div>`;}).join('')||`<div style="padding:16px 0;text-align:center;"><span style="font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;">No tasks assigned</span></div>`;
  const cfCount=tasks.filter(t=>isCarryForward(t)).length;
  return`<div class="daily-card"><div class="dc-head"><div class="dc-av" style="background:${u.bg};color:white;">${u.name[0]}</div>
  <div style="flex:1;"><div class="dc-name">${u.name} ${isFounderUser?'<span style="font-size:10px;background:var(--gold-bg);color:var(--gold);padding:2px 8px;border-radius:10px;border:1px solid rgba(184,134,11,0.2);font-family:\'DM Mono\',monospace;">FOUNDER</span>':''}</div>
  <div class="dc-sub">${done}/${tasks.length} completed ${cfCount>0?`¬∑ <span style="color:#e65100;">‚Ü© ${cfCount} carried</span>`:''}</div></div></div>
  <div style="padding:12px 18px 0;"><div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
  <div class="prog-labels"><span>Progress</span><span style="font-weight:700;color:${pct===100?'var(--success)':'var(--text4)'};">${pct}%</span></div></div>
  <div class="dc-body">${items}</div></div>`;
}

async function toggleDone(id){
  const t=S.tasks.find(t=>t.id===id);if(!t)return;
  t.status=t.status==='done'?'pending':'done';
  await dbSave('tasks',{id:t.id,status:t.status});
  await addAct(`"${t.name}" marked ${t.status}`,t.assign_to,t.status==='done'?'‚úÖ':'‚≠ï');
  refreshCurrentPage();
}

function rFounderProjects(){
  const el=document.getElementById('page-f-projects');
  const sc={active:'b-done',planning:'b-pend',paused:'b-block',done:'b-na'};
  // Summary stats
  const total=S.projects.length,active=S.projects.filter(p=>p.status==='active').length,client=S.projects.filter(p=>p.type==='client').length,internal=S.projects.filter(p=>p.type==='internal').length;
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Projects</div><div class="ph-sub">CLIENT & INTERNAL TRACKER</div></div><button class="btn btn-primary" onclick="openModal('modal-project')">+ New Project</button></div>
  <div class="stats-row" style="margin-bottom:20px;">
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">üìÅ</div><div class="stat-label">Total</div><div class="stat-value">${total}</div><div class="stat-sub">All projects</div></div>
    <div class="stat-card sc-blue"><div class="stat-icon-wrap sic-blue">‚ñ∂</div><div class="stat-label">Active</div><div class="stat-value">${active}</div><div class="stat-sub">Currently running</div></div>
    <div class="stat-card sc-gold"><div class="stat-icon-wrap sic-gold">üè¢</div><div class="stat-label">Client</div><div class="stat-value">${client}</div><div class="stat-sub">Client projects</div></div>
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">üåø</div><div class="stat-label">Internal</div><div class="stat-value">${internal}</div><div class="stat-sub">In-house</div></div>
  </div>
  <div class="proj-grid">${S.projects.length?S.projects.map(p=>{const pt=S.tasks.filter(t=>t.project===p.name),pd=pt.filter(t=>t.status==='done').length,pinp=pt.filter(t=>t.status==='inprogress').length;
  return`<div class="proj-card"><div class="pc-header"><div class="pc-name">${p.name}</div><span class="badge ${p.type==='client'?'b-client':'b-internal'}">${p.type==='client'?'CLIENT':'INTERNAL'}</span></div>
  <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px;"><span class="badge ${sc[p.status]||'b-na'}">${p.status.toUpperCase()}</span><span style="font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;">${pt.length} tasks ¬∑ ${pinp} active</span></div>
  <div class="pc-desc">${p.description||'No description.'}</div>
  <div class="prog-bar"><div class="prog-fill" style="width:${p.progress}%"></div></div>
  <div class="prog-labels" style="margin-bottom:14px;"><span>${pd}/${pt.length} done</span><span style="font-weight:700;">${p.progress}%</span></div>
  <div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border);"><button class="btn btn-outline btn-sm" style="flex:1;" onclick="openEditProject('${p.id}')">‚úè Edit</button><button class="btn btn-danger btn-sm" style="flex:1;" onclick="deleteProject('${p.id}')">üóë Delete</button></div></div>`;}).join(''):'<div class="empty-st"><div class="ei">üìÅ</div><p>No projects yet.</p></div>'}</div>`;
}

function rFounderActivity(){
  const el=document.getElementById('page-f-activity');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Activity Log</div><div class="ph-sub">ALL TEAM ACTIONS</div></div></div>
  <div class="act-list">${S.activity.length?S.activity.slice(0,80).map(a=>`<div class="act-item"><div class="act-ico">${a.icon}</div><div class="act-body"><div class="act-text">${a.text}</div>${a.sub?`<div class="act-sub">${a.sub}</div>`:''}<div class="act-time">${new Date(a.time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})} ¬∑ ${new Date(a.time).toLocaleDateString('en-IN',{day:'2-digit',month:'short'})}</div></div></div>`).join(''):'<div class="empty-st"><div class="ei">üìã</div><p>No activity yet.</p></div>'}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOUNDER PRODUCTIVITY REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rFounderReport(){
  const el=document.getElementById('page-f-report');
  const allUsers=S.users;
  const total=S.tasks.length,done=S.tasks.filter(t=>t.status==='done').length,deployed=S.tasks.filter(t=>t.deploy==='yes').length,overdue=S.tasks.filter(t=>isCarryForward(t)).length;
  const compRate=total?Math.round(done/total*100):0;
  const teamRows=allUsers.map(u=>{
    const ut=S.tasks.filter(t=>t.assign_to===u.name);
    const ud=ut.filter(t=>t.status==='done').length;
    const udep=ut.filter(t=>t.deploy==='yes').length;
    const uow=ut.filter(t=>isCarryForward(t)).length;
    const pct=ut.length?Math.round(ud/ut.length*100):0;
    const totalMin=getTotalWorkMinutes(u.id);
    const todayMin=getTodayWorkMinutes(u.id);
    return{u,ut,ud,udep,uow,pct,totalMin,todayMin};
  });
  
  el.innerHTML=`<div class="ph"><div><div class="ph-title">üìä Productivity Report</div><div class="ph-sub">FULL TEAM ANALYSIS ¬∑ ${today().toUpperCase()}</div></div>
  <div class="ph-actions">
    <button class="btn btn-outline" onclick="window.print()">üñ® Print</button>
    <button class="btn btn-primary" onclick="openSignModal()">‚úçÔ∏è Sign & Download PDF</button>
  </div></div>
  <div id="report-content">
  <div class="report-section">
    <h3>üìà Overall Team Performance</h3>
    <div class="report-grid">
      <div class="rg-item"><div class="rg-val">${total}</div><div class="rg-lbl">Total Tasks</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--success);">${done}</div><div class="rg-lbl">Completed</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--gold);">${deployed}</div><div class="rg-lbl">Deployed</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--danger);">${overdue}</div><div class="rg-lbl">Overdue</div></div>
    </div>
    <div style="text-align:center;padding:16px;background:${compRate>=80?'var(--green6)':compRate>=50?'#fef9e7':'#fdf0ef'};border-radius:10px;border:1px solid ${compRate>=80?'var(--border2)':compRate>=50?'rgba(214,137,16,0.2)':'rgba(192,57,43,0.2)'};">
      <div style="font-size:12px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:4px;">OVERALL COMPLETION RATE</div>
      <div style="font-family:'Fraunces',serif;font-size:48px;font-weight:700;color:${compRate>=80?'var(--green)':compRate>=50?'var(--gold)':'var(--danger)'};">${compRate}%</div>
      <div style="font-size:13px;color:var(--text3);margin-top:4px;">${compRate>=80?'üåü Excellent performance!':compRate>=50?'‚ö° Good, keep pushing!':'‚ö† Needs improvement'}</div>
    </div>
  </div>
  <div class="report-section">
    <h3>üë• Individual Member Analysis</h3>
    ${teamRows.map(({u,ut,ud,udep,uow,pct,totalMin,todayMin})=>`
    <div class="member-report-row">
      <div style="width:44px;height:44px;border-radius:11px;background:${u.bg};color:white;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0;">${u.name[0]}</div>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:800;color:var(--text);">${u.name} <span style="font-size:11px;color:var(--text4);font-family:'DM Mono',monospace;">${u.title}</span></div>
        <div style="display:flex;gap:16px;margin-top:6px;font-size:12px;font-family:'DM Mono',monospace;">
          <span>Tasks: <strong>${ut.length}</strong></span>
          <span style="color:var(--success);">Done: <strong>${ud}</strong></span>
          <span style="color:var(--gold);">Deployed: <strong>${udep}</strong></span>
          ${uow>0?`<span style="color:var(--danger);">Overdue: <strong>${uow}</strong></span>`:''}
          ${totalMin>0?`<span style="color:var(--info);">Work: <strong>${fmtDuration(totalMin)}</strong></span>`:''}
          ${todayMin>0?`<span style="color:var(--green);">Today: <strong>${fmtDuration(todayMin)}</strong></span>`:''}
        </div>
        <div style="margin-top:8px;"><div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
        <div class="prog-labels"><span>Completion</span><span style="font-weight:700;color:${pct>=80?'var(--success)':pct>=50?'var(--warn)':'var(--danger)'};">${pct}%</span></div></div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:${pct>=80?'var(--green)':pct>=50?'var(--gold)':'var(--danger)'};">${pct}%</div>
        <div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;">${pct>=80?'‚≠ê TOP':'üìà AVG'}</div>
      </div>
    </div>`).join('')}
  </div>
  <div class="report-section">
    <h3>üìã Work Time Summary</h3>
    ${S.workSessions.length?`<div class="tbl-wrap" style="margin:0;"><table class="tbl"><thead><tr><th>Member</th><th>Date</th><th>Start</th><th>End</th><th>Duration</th></tr></thead><tbody>
    ${S.workSessions.slice(0,20).map(s=>`<tr><td class="td-name">${s.user_name}</td><td style="font-family:'DM Mono',monospace;font-size:12px;">${s.date}</td>
    <td style="font-family:'DM Mono',monospace;font-size:11px;">${s.start_time?new Date(s.start_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;font-size:11px;">${s.end_time?new Date(s.end_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'üü¢ Active'}</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--info);">${s.duration_minutes?fmtDuration(s.duration_minutes):'‚Äî'}</td></tr>`).join('')}
    </tbody></table></div>`:'<div class="empty-st"><div class="ei">‚è±</div><p>No work sessions recorded yet.</p></div>'}
  </div>
  <div class="report-section">
    <h3>üìä Analysis & Recommendations</h3>
    ${generateAnalysis(teamRows,total,done,overdue)}
  </div>
  </div>`;
}

function generateAnalysis(teamRows,total,done,overdue){
  const lines=[];
  const compRate=total?Math.round(done/total*100):0;
  if(compRate>=80)lines.push('‚úÖ <strong>Excellent:</strong> The team is maintaining an excellent task completion rate above 80%. Continue the momentum and focus on deployment quality.');
  else if(compRate>=60)lines.push('‚ö° <strong>Good Progress:</strong> Team completion rate is at a healthy level. Focus on reducing the backlog of pending tasks.');
  else lines.push('‚ö† <strong>Attention Required:</strong> Completion rate is below 60%. Consider reviewing task assignments and removing blockers.');
  if(overdue>0)lines.push(`üîÑ <strong>Carryforward Alert:</strong> ${overdue} task(s) are overdue and carried forward. Prioritize these tasks urgently to prevent further delay.`);
  const topPerformer=teamRows.sort((a,b)=>b.pct-a.pct)[0];
  if(topPerformer&&topPerformer.pct>0)lines.push(`üåü <strong>Top Performer:</strong> ${topPerformer.u.name} leads with ${topPerformer.pct}% task completion and ${topPerformer.udep} deployments. Excellent contribution!`);
  const lowPerformer=teamRows.filter(r=>r.ut.length>0).sort((a,b)=>a.pct-b.pct)[0];
  if(lowPerformer&&lowPerformer.pct<50&&lowPerformer.ut.length>2)lines.push(`üí° <strong>Support Needed:</strong> ${lowPerformer.u.name} has ${lowPerformer.pct}% completion. Consider a 1:1 check-in to identify and remove blockers.`);
  const totalWorkMin=teamRows.reduce((a,r)=>a+r.totalMin,0);
  if(totalWorkMin>0)lines.push(`‚è± <strong>Total Work Time Logged:</strong> ${fmtDuration(totalWorkMin)} across all team members.`);
  lines.push(`üìÖ <strong>Report Generated:</strong> ${new Date().toLocaleString('en-IN',{dateStyle:'full',timeStyle:'short'})} by ${S.me.name} (Founder & CEO)`);
  return`<div style="display:flex;flex-direction:column;gap:10px;">${lines.map(l=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:9px;border:1px solid var(--border);font-size:13px;color:var(--text2);line-height:1.6;">${l}</div>`).join('')}</div>`;
}

function openSignModal(){openModal('modal-sign');initSigCanvas();}
let sigDrawing=false,sigCtx=null;
function initSigCanvas(){
  const canvas=document.getElementById('sig-canvas');if(!canvas)return;
  sigCtx=canvas.getContext('2d');
  sigCtx.clearRect(0,0,canvas.width,canvas.height);
  sigCtx.strokeStyle='#2d6a2f';sigCtx.lineWidth=2.5;sigCtx.lineCap='round';sigCtx.lineJoin='round';
  canvas.onmousedown=e=>{sigDrawing=true;const r=canvas.getBoundingClientRect();sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);};
  canvas.onmousemove=e=>{if(!sigDrawing)return;const r=canvas.getBoundingClientRect();sigCtx.lineTo(e.clientX-r.left,e.clientY-r.top);sigCtx.stroke();};
  canvas.onmouseup=canvas.onmouseleave=()=>{sigDrawing=false;};
  // Touch support
  canvas.ontouchstart=e=>{e.preventDefault();sigDrawing=true;const r=canvas.getBoundingClientRect(),t=e.touches[0];sigCtx.beginPath();sigCtx.moveTo(t.clientX-r.left,t.clientY-r.top);};
  canvas.ontouchmove=e=>{e.preventDefault();if(!sigDrawing)return;const r=canvas.getBoundingClientRect(),t=e.touches[0];sigCtx.lineTo(t.clientX-r.left,t.clientY-r.top);sigCtx.stroke();};
  canvas.ontouchend=()=>{sigDrawing=false;};
}
function clearSig(){if(sigCtx)sigCtx.clearRect(0,0,560,150);}

async function downloadReport(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
  const pw=doc.internal.pageSize.getWidth();
  let y=15;
  // Header
  doc.setFillColor(45,106,47);doc.rect(0,0,pw,30,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');
  doc.text('FicusAgentAI ‚Äî Productivity Report',pw/2,12,{align:'center'});
  doc.setFontSize(9);doc.setFont('helvetica','normal');
  doc.text(`Generated: ${new Date().toLocaleString('en-IN')} ¬∑ By: ${S.me.name}`,pw/2,20,{align:'center'});
  doc.text(`Date: ${today()}`,pw/2,26,{align:'center'});
  y=40;
  // Stats
  doc.setTextColor(26,46,26);doc.setFontSize(13);doc.setFont('helvetica','bold');
  doc.text('Overall Performance',14,y);y+=7;
  const total=S.tasks.length,done=S.tasks.filter(t=>t.status==='done').length,deployed=S.tasks.filter(t=>t.deploy==='yes').length,overdue=S.tasks.filter(t=>isCarryForward(t)).length,compRate=total?Math.round(done/total*100):0;
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(61,93,61);
  doc.text(`Total Tasks: ${total}   Completed: ${done}   Deployed: ${deployed}   Overdue: ${overdue}   Rate: ${compRate}%`,14,y);y+=14;
  // Team members
  doc.setFontSize(13);doc.setFont('helvetica','bold');doc.setTextColor(26,46,26);
  doc.text('Team Member Analysis',14,y);y+=7;
  S.users.forEach(u=>{
    const ut=S.tasks.filter(t=>t.assign_to===u.name);
    const ud=ut.filter(t=>t.status==='done').length;
    const pct=ut.length?Math.round(ud/ut.length*100):0;
    const totalMin=getTotalWorkMinutes(u.id);
    doc.setFontSize(10);doc.setFont('helvetica','bold');doc.setTextColor(26,46,26);
    doc.text(`${u.name} ‚Äî ${u.title}`,14,y);
    doc.setFont('helvetica','normal');doc.setTextColor(61,93,61);doc.setFontSize(9);
    doc.text(`Tasks: ${ut.length}  Done: ${ud}  Rate: ${pct}%  Work: ${totalMin>0?fmtDuration(totalMin):'N/A'}`,14,y+5);
    y+=14;if(y>260){doc.addPage();y=20;}
  });
  y+=6;
  // Analysis
  doc.setFontSize(13);doc.setFont('helvetica','bold');doc.setTextColor(26,46,26);
  doc.text('Analysis',14,y);y+=7;
  doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(61,93,61);
  const analyses=[
    `Completion Rate: ${compRate}% ‚Äî ${compRate>=80?'Excellent':compRate>=60?'Good':'Needs Improvement'}`,
    overdue>0?`${overdue} tasks are overdue and carried forward. Requires urgent attention.`:'No overdue tasks. Great work!',
    `Report signed by: ${S.me.name} (Founder & CEO, FicusAgentAI)`,
  ];
  analyses.forEach(line=>{doc.text(line,14,y,{maxWidth:pw-28});y+=7;});
  // Signature
  const canvas=document.getElementById('sig-canvas');
  if(canvas){
    const sigData=canvas.toDataURL('image/png');
    y+=10;
    doc.setFontSize(11);doc.setFont('helvetica','bold');doc.setTextColor(26,46,26);
    doc.text('Authorized Signature:',14,y);y+=8;
    doc.addImage(sigData,'PNG',14,y,80,30);y+=35;
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(100,130,100);
    doc.text(`${S.me.name}, Founder & CEO ‚Äî FicusAgentAI`,14,y);
    doc.line(14,y-4,100,y-4);
  }
  // Footer
  doc.setFillColor(232,245,233);doc.rect(0,285,pw,12,'F');
  doc.setFontSize(8);doc.setTextColor(100,150,100);
  doc.text('FicusAgentAI ‚Äî Confidential Report ‚Äî ficusagentai.com',pw/2,292,{align:'center'});
  doc.save(`FicusAgentAI_Report_${todayStr()}.pdf`);
  closeModal('modal-sign');showToast('üì• Report downloaded!');
}

function rFounderSettings(){
  const el=document.getElementById('page-f-settings');
  const emps=S.users.filter(u=>u.role==='employee');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Settings & Users</div><div class="ph-sub">ADMIN PANEL</div></div></div>
  <div class="settings-card">
    <div class="settings-head">üåø Founder Profile</div>
    <div class="profile-big" onclick="openMyProfile()">
      <div class="pb-av" style="background:${S.me.bg||'linear-gradient(135deg,#f0c040,#d4a017)'};color:white;">${S.me.name[0]}</div>
      <div><div class="pb-name">${S.me.name}</div><div class="pb-role">Founder & CEO ¬∑ @${S.me.username}</div>
      <div style="margin-top:8px;display:flex;gap:8px;"><span class="badge b-client">ADMIN</span><span class="badge b-done">FULL ACCESS</span></div></div>
      <div style="margin-left:auto;"><button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openChangePass()">üîê Change Password</button></div>
    </div>
  </div>
  <div class="settings-card">
    <div class="settings-head"><span>üë• Team Credentials</span><button class="btn btn-primary btn-sm" onclick="openModal('modal-member')">+ Add Member</button></div>
    <div class="tbl-wrap" style="margin:0;"><table class="tbl"><thead><tr><th>Name</th><th>Username</th><th>Password</th><th>Tasks</th><th>Actions</th></tr></thead><tbody>
    ${emps.length?emps.map(u=>`<tr><td><div style="display:flex;align-items:center;gap:8px;cursor:pointer;" onclick="openProfileModal('${u.id}')"><div style="width:30px;height:30px;border-radius:8px;background:${u.bg};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;">${u.name[0]}</div>
    <div><div style="font-weight:700;color:var(--text);font-size:13px;">${u.name}</div><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;">${u.title}</div></div></div></td>
    <td><span style="font-family:'DM Mono',monospace;color:var(--green);">@${u.username}</span></td>
    <td><span class="pass-cell" id="stpw-${u.id}" onclick="revealPassS('${u.id}')" title="Click to reveal">‚óè‚óè‚óè‚óè‚óè üëÅ</span></td>
    <td style="font-family:'DM Mono',monospace;">${S.tasks.filter(t=>t.assign_to===u.name).length}</td>
    <td><div class="r-actions"><button class="r-btn" onclick="openProfileModal('${u.id}')">üëÅ</button><button class="r-btn" onclick="openEditMember('${u.id}')">‚úè Edit</button><button class="r-btn" onclick="openResetPass('${u.id}')" style="color:var(--gold);border-color:rgba(184,134,11,0.3);">üîë Reset</button><button class="r-btn del" onclick="removeMember('${u.id}')">üóë</button></div></td></tr>`).join(''):'<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text4);">No team members yet.</td></tr>'}
    </tbody></table></div>
  </div>
  <div class="settings-card" style="background:var(--gold-bg);border-color:rgba(184,134,11,0.2);">
    <div class="settings-head" style="color:var(--gold);">‚òÅÔ∏è Connected to Supabase</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.7;">All data is synced to Supabase cloud in real-time.<br><br><button class="btn btn-danger btn-sm" onclick="disconnectSupabase()">üîå Disconnect / Change Project</button></div>
  </div>`;
}

function disconnectSupabase(){if(!confirm('Remove Supabase config?'))return;localStorage.removeItem(CFG_KEY);location.reload();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMyProfile(){openProfileModal(S.me.id);}
function openProfileModal(uid){
  const u=S.users.find(u=>u.id===uid);if(!u)return;
  const ut=S.tasks.filter(t=>t.assign_to===u.name);
  const ud=ut.filter(t=>t.status==='done').length;
  const udep=ut.filter(t=>t.deploy==='yes').length;
  const upend=ut.filter(t=>t.status==='pending').length;
  const uinprog=ut.filter(t=>t.status==='inprogress').length;
  const pct=ut.length?Math.round(ud/ut.length*100):0;
  const totalMin=getTotalWorkMinutes(u.id);
  const todayMin=getTodayWorkMinutes(u.id);
  const sessions=S.workSessions.filter(s=>s.user_id===u.id).slice(0,7);
  const isOnline=isUserOnline(u.id);
  const userProjects=[...new Set(ut.filter(t=>t.project).map(t=>t.project))];
  
  document.getElementById('prof-modal-title').textContent=`${u.name}'s Profile`;
  document.getElementById('prof-modal-body').innerHTML=`
  <div class="profile-modal-header">
    <div class="profile-avatar-big" style="background:${u.bg||'linear-gradient(135deg,#2d6a2f,#3d8b40)'};color:white;">${u.name[0]}</div>
    <div style="font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--text);">${u.name}</div>
    <div style="font-size:13px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;">${u.title||'Team Member'}</div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center;">
      <span class="badge ${u.role==='founder'?'b-client':'b-internal'}">${u.role==='founder'?'üëë FOUNDER':'üë§ EMPLOYEE'}</span>
      <span class="badge ${isOnline?'b-done':'b-na'}">${isOnline?'üü¢ Online':'‚≠ò Offline'}</span>
      ${todayMin>0?`<span class="badge b-prog">‚è± Today: ${fmtDuration(todayMin)}</span>`:''}
    </div>
  </div>
  <!-- Contact Info -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
    ${u.phone?`<div style="padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;font-size:12px;"><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:3px;">üì± PHONE</div><div style="font-weight:600;color:var(--text);">${u.phone}</div></div>`:''}
    ${u.email?`<div style="padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;font-size:12px;"><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:3px;">üìß EMAIL</div><div style="font-weight:600;color:var(--text);">${u.email}</div></div>`:''}
    <div style="padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;font-size:12px;"><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:3px;">üë§ USERNAME</div><div style="font-weight:600;color:var(--green);">@${u.username}</div></div>
    <div style="padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;font-size:12px;"><div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-bottom:3px;">‚è± TOTAL WORK</div><div style="font-weight:600;color:var(--info);">${totalMin>0?fmtDuration(totalMin):'Not tracked'}</div></div>
  </div>
  <!-- Stats -->
  <div class="profile-stats-row">
    <div class="profile-stat"><div class="profile-stat-val">${ut.length}</div><div class="profile-stat-lbl">Total Tasks</div></div>
    <div class="profile-stat"><div class="profile-stat-val" style="color:var(--success);">${ud}</div><div class="profile-stat-lbl">Completed</div></div>
    <div class="profile-stat"><div class="profile-stat-val" style="color:var(--gold);">${udep}</div><div class="profile-stat-lbl">Deployed</div></div>
  </div>
  <div style="margin-bottom:16px;"><div class="prog-bar" style="height:8px;"><div class="prog-fill" style="width:${pct}%"></div></div>
  <div class="prog-labels"><span>Completion Rate</span><span style="font-weight:800;color:${pct>=80?'var(--success)':pct>=50?'var(--gold)':'var(--danger)'};">${pct}%</span></div></div>
  <!-- Current Tasks -->
  <div style="margin-bottom:14px;"><div class="sec-title" style="margin-bottom:10px;">Current Tasks</div>
  ${upend>0||uinprog>0?`<div style="display:flex;gap:6px;flex-wrap:wrap;">${ut.filter(t=>t.status!=='done').slice(0,6).map(t=>`<span class="badge ${t.status==='inprogress'?'b-prog':'b-pend'}">${t.name}</span>`).join('')}</div>`:'<span style="font-size:12px;color:var(--text4);font-family:\'DM Mono\',monospace;">All tasks completed! üéâ</span>'}
  </div>
  <!-- Projects -->
  ${userProjects.length?`<div style="margin-bottom:14px;"><div class="sec-title" style="margin-bottom:10px;">Projects Involved</div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;">${userProjects.map(p=>`<span class="badge b-client">üìÅ ${p}</span>`).join('')}</div></div>`:''}
  <!-- Work Sessions -->
  ${sessions.length?`<div><div class="sec-title" style="margin-bottom:10px;">Recent Work Sessions</div>
  <div style="display:flex;flex-direction:column;gap:6px;">${sessions.slice(0,5).map(s=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'DM Mono',monospace;">
  <span>üìÖ ${s.date}</span><span>‚ñ∂ ${s.start_time?new Date(s.start_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'‚Äî'}</span><span>‚èπ ${s.end_time?new Date(s.end_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'üü¢ Active'}</span><span style="font-weight:700;color:var(--info);">${s.duration_minutes?fmtDuration(s.duration_minutes):'‚Äî'}</span></div>`).join('')}</div></div>`:''}
  ${S.role==='founder'&&u.role!=='founder'?`<div style="margin-top:16px;display:flex;gap:8px;">
  <button class="btn btn-outline btn-sm" onclick="closeModal('modal-profile');openEditMember('${u.id}')">‚úè Edit Member</button>
  <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-profile');openResetPass('${u.id}')">üîë Reset Password</button>
  </div>`:''}`;
  openModal('modal-profile');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMPLOYEE PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rEmpDash(){
  const el=document.getElementById('page-e-dashboard'),u=S.me;
  const mt=S.tasks.filter(t=>t.assign_to===u.name);
  const done=mt.filter(t=>t.status==='done').length,inprog=mt.filter(t=>t.status==='inprogress').length;
  const deployed=mt.filter(t=>t.deploy==='yes').length,pending=mt.filter(t=>t.status==='pending').length;
  const cf=mt.filter(t=>isCarryForward(t));
  const tdw=getTodayWorkMinutes(u.id),totalw=getTotalWorkMinutes(u.id);
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Good ${getGreeting()}, ${u.name} üëã</div><div class="ph-sub">${today().toUpperCase()}</div></div></div>
  ${cf.length>0?`<div class="carry-banner"><span>‚Ü©</span><span>${cf.length} task(s) carried forward from previous days. <strong>Complete them first!</strong></span></div>`:''}
  ${pending>0?`<div class="ann-banner" style="margin-bottom:16px;"><div>‚è≥</div><div>You have <strong>${pending} pending task${pending!==1?'s':''}</strong> waiting!</div></div>`:''}
  <!-- Online Button Hint -->
  <div style="padding:14px 18px;background:var(--green6);border:1px solid var(--border2);border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
    <div style="font-size:24px;">‚è±</div>
    <div>
      <div style="font-weight:800;font-size:14px;color:var(--green);">Track Your Work Time</div>
      <div style="font-size:12px;color:var(--text3);">Click "Go Online" button in the top bar when you start working. Click again to stop and save your session.</div>
    </div>
    ${tdw>0?`<div style="margin-left:auto;text-align:center;"><div style="font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--green);">${fmtDuration(tdw)}</div><div style="font-size:10px;color:var(--text4);">Today's time</div></div>`:''}
  </div>
  <div class="stats-row">
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">üìã</div><div class="stat-label">My Tasks</div><div class="stat-value">${mt.length}</div><div class="stat-sub">Total</div></div>
    <div class="stat-card sc-green"><div class="stat-icon-wrap sic-green">‚úÖ</div><div class="stat-label">Completed</div><div class="stat-value">${done}</div><div class="stat-sub">Keep going!</div></div>
    <div class="stat-card sc-blue"><div class="stat-icon-wrap sic-blue">‚ü≥</div><div class="stat-label">In Progress</div><div class="stat-value">${inprog}</div><div class="stat-sub">Working on</div></div>
    <div class="stat-card sc-gold"><div class="stat-icon-wrap sic-gold">üöÄ</div><div class="stat-label">Deployed</div><div class="stat-value">${deployed}</div><div class="stat-sub">Live!</div></div>
  </div>
  <div class="sec-head"><div class="sec-title">My Tasks ${cf.length>0?`<span class="badge b-carry">‚Ü© ${cf.length} Carryforward</span>`:''}</div><button class="btn btn-ghost btn-sm" onclick="showPage('e-tasks')">View All ‚Üí</button></div>
  ${taskTable(mt.slice(0,6),false)}`;
}

function rEmpTasks(){
  const el=document.getElementById('page-e-tasks');
  const mt=S.tasks.filter(t=>t.assign_to===S.me.name);
  const cfTasks=mt.filter(t=>isCarryForward(t));
  el.innerHTML=`<div class="ph"><div><div class="ph-title">My Tasks</div><div class="ph-sub">UPDATE STATUS ¬∑ MARK DEPLOYED</div></div></div>
  ${cfTasks.length>0?`<div class="carry-banner"><span>‚Ü©</span><strong>${cfTasks.length} Carryforward task(s):</strong> ${cfTasks.map(t=>t.name).join(', ')}</div>`:''}
  ${mt.length?`<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Task</th><th>Status</th><th>Deploy</th><th>Priority</th><th>Due</th><th>Quick Update</th></tr></thead><tbody>
  ${mt.sort((a,b)=>{if(isCarryForward(a)&&!isCarryForward(b))return-1;if(!isCarryForward(a)&&isCarryForward(b))return 1;return 0;}).map(t=>{const cf=isCarryForward(t);
  return`<tr style="${cf?'background:rgba(230,81,0,0.04);border-left:3px solid #e65100;':''}">
  <td><div class="td-name">${t.name}${cf?'<span class="carry-tag" style="margin-left:6px;">‚Ü© CARRYFORWARD</span>':''}</div>${t.project?`<div style="font-size:10px;color:var(--text4);font-family:'DM Mono',monospace;margin-top:2px;">üìÅ ${t.project}</div>`:''}</td>
  <td>${statusBadge(t.status)}</td><td>${deployBadge(t.deploy)}</td><td>${prioBadge(t.priority)}</td>
  <td style="font-size:11px;font-family:'DM Mono',monospace;color:${cf?'var(--danger)':'var(--text4)'};">${cf?'‚ö† ':''} ${fmtDate(t.due_date)}</td>
  <td><div class="r-actions">${t.status!=='inprogress'?`<button class="r-btn" onclick="empUpdate('${t.id}','inprogress')" style="color:var(--info);border-color:rgba(26,111,168,0.3);">‚ñ∂ Start</button>`:''} ${t.status!=='done'?`<button class="r-btn" onclick="empUpdate('${t.id}','done')" style="color:var(--success);border-color:rgba(30,132,73,0.3);">‚úì Done</button>`:''}<button class="r-btn" onclick="empDeploy('${t.id}')" style="color:var(--gold);border-color:rgba(184,134,11,0.3);">üöÄ ${t.deploy==='yes'?'Unmark':'Deploy'}</button></div></td></tr>`;}).join('')}
  </tbody></table></div>`:'<div class="empty-st"><div class="ei">üìã</div><p>No tasks assigned yet!</p></div>'}`;
}

async function empUpdate(id,status){
  const t=S.tasks.find(t=>t.id===id);if(!t)return;
  t.status=status;
  await dbSave('tasks',{id:t.id,status});
  await addAct(`"${t.name}" ‚Üí ${status}`,S.me.name,status==='done'?'‚úÖ':'‚ñ∂');
  rEmpTasks();showToast(`Task: ${status}`);
}
async function empDeploy(id){
  const t=S.tasks.find(t=>t.id===id);if(!t)return;
  t.deploy=t.deploy==='yes'?'no':'yes';
  if(t.deploy==='yes')t.status='done';
  await dbSave('tasks',{id:t.id,deploy:t.deploy,status:t.status});
  if(t.deploy==='yes')await addAct(`"${t.name}" deployed! üöÄ`,S.me.name,'üöÄ');
  rEmpTasks();showToast(t.deploy==='yes'?'üöÄ Deployed!':'Deploy removed.');
}

function rEmpProjects(){
  const el=document.getElementById('page-e-projects');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Projects</div><div class="ph-sub">YOUR PROJECT OVERVIEW</div></div></div>
  <div class="proj-grid">${S.projects.length?S.projects.map(p=>{const pt=S.tasks.filter(t=>t.project===p.name),myPt=pt.filter(t=>t.assign_to===S.me.name),pd=pt.filter(t=>t.status==='done').length;const sc={active:'b-done',planning:'b-pend',paused:'b-block',done:'b-na'}[p.status]||'b-na';
  return`<div class="proj-card"><div class="pc-header"><div class="pc-name">${p.name}</div><span class="badge ${p.type==='client'?'b-client':'b-internal'}">${p.type==='client'?'CLIENT':'INTERNAL'}</span></div>
  <div style="margin-bottom:10px;display:flex;gap:8px;"><span class="badge ${sc}">${p.status.toUpperCase()}</span>${myPt.length?`<span class="badge b-prog">My Tasks: ${myPt.length}</span>`:''}</div>
  <div class="pc-desc">${p.description||'No description.'}</div>
  <div class="prog-bar"><div class="prog-fill" style="width:${p.progress}%"></div></div>
  <div class="prog-labels"><span>${pd}/${pt.length} done</span><span style="font-weight:700;">${p.progress}%</span></div></div>`;}).join(''):'<div class="empty-st"><div class="ei">üìÅ</div><p>No projects yet.</p></div>'}</div>`;
}

function rEmpDaily(){
  const el=document.getElementById('page-e-daily');
  el.innerHTML=`<div class="ph"><div><div class="ph-title">Daily Checklist</div><div class="ph-sub">${today().toUpperCase()}</div></div></div><div class="daily-grid">${dailyCard(S.me)}</div>`;
}

function rEmpReport(){
  const el=document.getElementById('page-e-report');
  const u=S.me;
  const mt=S.tasks.filter(t=>t.assign_to===u.name);
  const done=mt.filter(t=>t.status==='done').length,inprog=mt.filter(t=>t.status==='inprogress').length;
  const deployed=mt.filter(t=>t.deploy==='yes').length,pct=mt.length?Math.round(done/mt.length*100):0;
  const totalMin=getTotalWorkMinutes(u.id),todayMin=getTodayWorkMinutes(u.id);
  const sessions=S.workSessions.filter(s=>s.user_id===u.id);
  el.innerHTML=`<div class="ph"><div><div class="ph-title">My Report</div><div class="ph-sub">PERSONAL PRODUCTIVITY</div></div></div>
  <div class="report-section">
    <h3>My Performance</h3>
    <div class="report-grid">
      <div class="rg-item"><div class="rg-val">${mt.length}</div><div class="rg-lbl">Total</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--success);">${done}</div><div class="rg-lbl">Done</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--gold);">${deployed}</div><div class="rg-lbl">Deployed</div></div>
      <div class="rg-item"><div class="rg-val" style="color:var(--info);">${pct}%</div><div class="rg-lbl">Rate</div></div>
    </div>
    <div style="margin-top:10px;"><div class="prog-bar" style="height:8px;"><div class="prog-fill" style="width:${pct}%"></div></div>
    <div class="prog-labels"><span>Completion Rate</span><span style="font-weight:800;color:${pct>=80?'var(--success)':pct>=50?'var(--gold)':'var(--danger)'};">${pct}%</span></div></div>
  </div>
  <div class="report-section">
    <h3>‚è± Work Time</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div style="padding:16px;background:var(--green6);border:1px solid var(--border2);border-radius:10px;text-align:center;">
        <div style="font-family:'DM Mono',monospace;font-size:24px;font-weight:700;color:var(--green);">${todayMin>0?fmtDuration(todayMin):'‚Äî'}</div>
        <div style="font-size:11px;color:var(--text4);margin-top:4px;">Today's Work Time</div>
      </div>
      <div style="padding:16px;background:var(--green6);border:1px solid var(--border2);border-radius:10px;text-align:center;">
        <div style="font-family:'DM Mono',monospace;font-size:24px;font-weight:700;color:var(--green);">${totalMin>0?fmtDuration(totalMin):'‚Äî'}</div>
        <div style="font-size:11px;color:var(--text4);margin-top:4px;">Total Work Time</div>
      </div>
    </div>
    ${sessions.length?`<div class="tbl-wrap" style="margin:0;"><table class="tbl"><thead><tr><th>Date</th><th>Start</th><th>End</th><th>Duration</th></tr></thead><tbody>
    ${sessions.slice(0,10).map(s=>`<tr><td style="font-family:'DM Mono',monospace;font-size:12px;">${s.date}</td>
    <td style="font-family:'DM Mono',monospace;font-size:11px;">${s.start_time?new Date(s.start_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;font-size:11px;">${s.end_time?new Date(s.end_time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'üü¢ Active'}</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--info);">${s.duration_minutes?fmtDuration(s.duration_minutes):'‚Äî'}</td></tr>`).join('')}</tbody></table></div>`
    :'<div class="empty-st"><div class="ei">‚è±</div><p>Start the online timer to track work sessions!</p></div>'}
  </div>`;
}

function rEmpSettings(){
  const el=document.getElementById('page-e-settings'),u=S.me;
  const mt=S.tasks.filter(t=>t.assign_to===u.name);
  el.innerHTML=`<div class="ph"><div><div class="ph-title">My Settings</div><div class="ph-sub">PROFILE & SECURITY</div></div></div>
  <div class="settings-card"><div class="settings-head">My Profile</div>
  <div class="profile-big" onclick="openMyProfile()">
    <div class="pb-av" style="background:${u.bg||'var(--green)'};color:white;">${u.name[0]}</div>
    <div><div class="pb-name">${u.name}</div><div class="pb-role">${u.title} ¬∑ @${u.username}</div>
    ${u.phone?`<div style="font-size:12px;color:var(--text3);margin-top:4px;">üì± ${u.phone}</div>`:''}
    ${u.email?`<div style="font-size:12px;color:var(--text3);">üìß ${u.email}</div>`:''}
    <div style="margin-top:10px;display:flex;gap:8px;font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);">
      <span>Tasks: <strong style="color:var(--text);">${mt.length}</strong></span>
      <span>Done: <strong style="color:var(--success);">${mt.filter(t=>t.status==='done').length}</strong></span>
      <span>Deployed: <strong style="color:var(--gold);">${mt.filter(t=>t.deploy==='yes').length}</strong></span>
    </div></div>
    <div style="margin-left:auto;"><button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openChangePass()">üîê Change Password</button></div>
  </div></div>
  <div class="ann-banner"><div>üí°</div><div style="font-size:13px;">Use the <strong>"Go Online"</strong> button at top when you start working ‚Äî it tracks your productive hours!</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASK CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTaskModal(id=null){
  document.getElementById('task-modal-title').textContent=id?'Edit Task':'New Task';
  document.getElementById('tm-id').value=id||'';
  const t=id?S.tasks.find(t=>t.id===id):null;
  document.getElementById('tm-name').value=t?.name||'';
  document.getElementById('tm-desc').value=t?.description||'';
  document.getElementById('tm-priority').value=t?.priority||'medium';
  document.getElementById('tm-status').value=t?.status||'pending';
  document.getElementById('tm-deploy').value=t?.deploy||'no';
  document.getElementById('tm-due').value=t?.due_date||new Date().toISOString().split('T')[0];
  const sel=document.getElementById('tm-assign');
  sel.innerHTML=S.users.map(u=>`<option value="${u.name}" ${t?.assign_to===u.name?'selected':''}>${u.name} ‚Äî ${u.title}</option>`).join('');
  const psel=document.getElementById('tm-project-sel');
  psel.innerHTML='<option value="">‚Äî No Project ‚Äî</option>'+S.projects.map(p=>`<option value="${p.name}" ${t?.project===p.name?'selected':''}>${p.name}</option>`).join('');
  openModal('modal-task');
}
async function saveTask(){
  const name=document.getElementById('tm-name').value.trim();
  if(!name){showToast('‚ö† Task name required!');return;}
  const id=document.getElementById('tm-id').value;
  const assignTo=document.getElementById('tm-assign').value;
  const data={name,description:document.getElementById('tm-desc').value,assign_to:assignTo,priority:document.getElementById('tm-priority').value,status:document.getElementById('tm-status').value,deploy:document.getElementById('tm-deploy').value,due_date:document.getElementById('tm-due').value,project:document.getElementById('tm-project-sel').value};
  if(id){
    const t=S.tasks.find(t=>t.id===id);if(t)Object.assign(t,data);
    await dbSave('tasks',{id,...data});
  }else{
    const newTask={id:genId(),...data};
    S.tasks.unshift(newTask);
    await dbSave('tasks',newTask);
    await addAct(`New task: "${name}"`,`Assigned to ${assignTo}`,'üìã');
    // Notify assigned user
    const assignedUser=S.users.find(u=>u.name===assignTo);
    if(assignedUser&&assignedUser.id!==S.me?.id){
      await addNotif(`New task assigned: "${name}"`,assignedUser.id,'task_assigned');
    }
  }
  closeModal('modal-task');updateNavCounts();
  refreshCurrentPage();showToast(id?'‚úì Task updated!':'‚úì Task created!');
}
async function deleteTask(id){
  const t=S.tasks.find(t=>t.id===id);
  if(!t||!confirm(`Delete "${t.name}"?`))return;
  S.tasks=S.tasks.filter(t=>t.id!==id);
  await dbDelete('tasks',id);
  await addAct(`Task deleted: "${t.name}"`,'','üóëÔ∏è');
  updateNavCounts();refreshCurrentPage();showToast('Task deleted.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS=['linear-gradient(135deg,#52a855,#2d6a2f)','linear-gradient(135deg,#4a9fd4,#1a6fa8)','linear-gradient(135deg,#d4a017,#b8860b)','linear-gradient(135deg,#e67e22,#ca6f1e)','linear-gradient(135deg,#8e44ad,#6c3483)'];
async function saveMember(){
  const name=document.getElementById('mm-name').value.trim();
  if(!name){showToast('‚ö† Name required!');return;}
  const username=document.getElementById('mm-username').value.trim()||name.toLowerCase().replace(/\s+/g,'');
  if(S.users.find(u=>u.username.toLowerCase()===username.toLowerCase())){showToast('‚ö† Username already taken!');return;}
  const m={id:genId(),name,role:'employee',title:document.getElementById('mm-role').value||'Team Member',phone:document.getElementById('mm-phone').value||'',email:document.getElementById('mm-email').value||'',username,password:document.getElementById('mm-password').value||'pass123',bg:COLORS[S.users.filter(u=>u.role==='employee').length%COLORS.length]};
  S.users.push(m);
  await dbSave('users',m);
  await addAct(`${name} joined the team!`,m.title,'üë§');
  closeModal('modal-member');['mm-name','mm-role','mm-phone','mm-email','mm-username','mm-password'].forEach(id=>{document.getElementById(id).value='';});
  buildSidebar();populateEmpSel();refreshCurrentPage();
  showToast(`‚úì ${name} added! Login: ${username} / ${m.password}`);
}
function openEditMember(id){
  const u=S.users.find(u=>u.id===id);if(!u)return;
  document.getElementById('em-id').value=id;
  document.getElementById('em-name').value=u.name;
  document.getElementById('em-role').value=u.title;
  document.getElementById('em-phone').value=u.phone||'';
  document.getElementById('em-email').value=u.email||'';
  document.getElementById('em-username').value=u.username;
  document.getElementById('em-password').value='';
  openModal('modal-edit-member');
}
async function updateMember(){
  const id=document.getElementById('em-id').value,u=S.users.find(u=>u.id===id);if(!u)return;
  const name=document.getElementById('em-name').value.trim();if(!name){showToast('‚ö† Name required!');return;}
  const oldName=u.name;
  u.name=name;u.title=document.getElementById('em-role').value||u.title;
  u.phone=document.getElementById('em-phone').value||'';
  u.email=document.getElementById('em-email').value||'';
  u.username=document.getElementById('em-username').value||u.username;
  const newpw=document.getElementById('em-password').value;if(newpw)u.password=newpw;
  S.tasks.forEach(t=>{if(t.assign_to===oldName)t.assign_to=name;});
  await dbSave('users',{id,name:u.name,title:u.title,phone:u.phone,email:u.email,username:u.username,...(newpw?{password:newpw}:{})});
  await addAct(`${name}'s profile updated`,'by Founder','‚úèÔ∏è');
  closeModal('modal-edit-member');buildSidebar();refreshCurrentPage();
  showToast(`${name}'s details updated!`);
}
async function removeMember(id){
  const u=S.users.find(u=>u.id===id);if(!u||!confirm(`Remove ${u.name}?`))return;
  S.users=S.users.filter(u=>u.id!==id);
  await dbDelete('users',id);
  await addAct(`${u.name} removed from team`,'by Founder','üóëÔ∏è');
  buildSidebar();refreshCurrentPage();showToast(`${u.name} removed.`);
}
function revealPass(id){const u=S.users.find(u=>u.id===id);if(!u)return;const el=document.getElementById('pc-'+id);if(!el)return;if(el.dataset.r==='1'){el.textContent='‚óè‚óè‚óè‚óè‚óè‚óè üëÅ';el.dataset.r='0';return;}el.textContent=u.password+' üîí';el.dataset.r='1';setTimeout(()=>{if(el){el.textContent='‚óè‚óè‚óè‚óè‚óè‚óè üëÅ';el.dataset.r='0';}},6000);}
function revealPassS(id){const u=S.users.find(u=>u.id===id);if(!u)return;const el=document.getElementById('stpw-'+id);if(!el)return;if(el.dataset.r==='1'){el.textContent='‚óè‚óè‚óè‚óè‚óè üëÅ';el.dataset.r='0';return;}el.textContent=u.password+' üîí';el.dataset.r='1';setTimeout(()=>{if(el){el.textContent='‚óè‚óè‚óè‚óè‚óè üëÅ';el.dataset.r='0';}},6000);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveProject(){
  const name=document.getElementById('pm-name').value.trim();if(!name){showToast('‚ö† Name required!');return;}
  const p={id:genId(),name,description:document.getElementById('pm-desc').value,type:document.getElementById('pm-type').value,status:document.getElementById('pm-status').value,progress:0};
  S.projects.push(p);await dbSave('projects',p);
  await addAct(`Project "${name}" created`,p.type,'üìÅ');
  closeModal('modal-project');['pm-name','pm-desc'].forEach(id=>{document.getElementById(id).value='';});
  refreshCurrentPage();showToast('‚úì Project created!');
}
function openEditProject(id){
  const p=S.projects.find(p=>p.id===id);if(!p)return;
  document.getElementById('ep-id').value=id;document.getElementById('ep-name').value=p.name;
  document.getElementById('ep-desc').value=p.description||'';document.getElementById('ep-type').value=p.type;
  document.getElementById('ep-status').value=p.status;document.getElementById('ep-progress').value=p.progress;
  document.getElementById('ep-prog-val').textContent=p.progress;openModal('modal-edit-project');
}
async function updateProject(){
  const id=document.getElementById('ep-id').value,p=S.projects.find(p=>p.id===id);if(!p)return;
  const name=document.getElementById('ep-name').value.trim();if(!name){showToast('‚ö† Name required!');return;}
  p.name=name;p.description=document.getElementById('ep-desc').value;p.type=document.getElementById('ep-type').value;p.status=document.getElementById('ep-status').value;p.progress=parseInt(document.getElementById('ep-progress').value);
  await dbSave('projects',{id,name:p.name,description:p.description,type:p.type,status:p.status,progress:p.progress});
  await addAct(`Project updated: "${name}"`,'','‚úèÔ∏è');
  closeModal('modal-edit-project');refreshCurrentPage();showToast('‚úì Project updated!');
}
async function deleteProject(id){
  const p=S.projects.find(p=>p.id===id);if(!p||!confirm(`Delete "${p.name}"?`))return;
  S.projects=S.projects.filter(p=>p.id!==id);
  await dbDelete('projects',id);await addAct(`Project deleted: "${p.name}"`,'','üóëÔ∏è');
  refreshCurrentPage();showToast('Project deleted.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASSWORD MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openChangePass(){
  document.getElementById('cp-user-display').textContent=`${S.me.name} (@${S.me.username})`;
  document.getElementById('cp-err').textContent='';
  ['cp-current','cp-new','cp-confirm'].forEach(id=>{document.getElementById(id).value='';});
  openModal('modal-changepass');
}
async function changePassword(){
  const cur=document.getElementById('cp-current').value,np=document.getElementById('cp-new').value,cf=document.getElementById('cp-confirm').value,err=document.getElementById('cp-err');
  err.textContent='';
  if(cur!==S.me.password){err.textContent='‚úó Current password incorrect.';return;}
  if(np.length<6){err.textContent='‚úó Min 6 characters.';return;}
  if(np!==cf){err.textContent='‚úó Passwords do not match.';return;}
  S.me.password=np;const u=S.users.find(u=>u.id===S.me.id);if(u)u.password=np;
  await dbSave('users',{id:S.me.id,password:np});
  await addAct(`${S.me.name} changed password`,`Role: ${S.role}`,'üîê');
  closeModal('modal-changepass');showToast('üîê Password updated!');
}
function openResetPass(id){
  const u=S.users.find(u=>u.id===id);if(!u)return;
  document.getElementById('rp-uid').value=id;
  document.getElementById('rp-name').value=`${u.name} (@${u.username})`;
  document.getElementById('rp-newpass').value='';document.getElementById('rp-confirm').value='';document.getElementById('rp-err').textContent='';
  openModal('modal-reset-pass');
}
async function founderResetPass(){
  const id=document.getElementById('rp-uid').value,u=S.users.find(u=>u.id===id);if(!u)return;
  const np=document.getElementById('rp-newpass').value,cf=document.getElementById('rp-confirm').value,err=document.getElementById('rp-err');
  err.textContent='';
  if(np.length<6){err.textContent='‚úó Min 6 characters.';return;}
  if(np!==cf){err.textContent='‚úó Passwords do not match.';return;}
  u.password=np;
  await dbSave('users',{id,password:np});
  await addAct(`${u.name}'s password reset by Founder`,u.username,'üîë');
  closeModal('modal-reset-pass');showToast(`üîë ${u.name}'s password reset!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MISC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleSearch(q){if(!q.trim())return;if(S.role==='founder'){S.filter='all';showPage('f-tasks');}}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(el=>{el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});});
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),3500);}
</script>
</body>
</html>
